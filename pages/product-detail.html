<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Critical initialization: BASE_PATH, cart preload, variant detection -->
  <script src="../scripts/critical-init.js"></script>
  <title>Product Detail - BuildRight Solutions</title>
  <link rel="stylesheet" href="../styles/styles.css">
  <link rel="stylesheet" href="../blocks/product-detail/product-detail.css">
</head>
<body class="page-product-detail">
  <!-- Header loaded dynamically from blocks/header/ -->
  <header></header>

  <main>
    <!-- Breadcrumbs Block -->
    <div class="breadcrumbs">
      <div>
        <div><a href="/">Home</a></div>
      </div>
      <div id="category-breadcrumb">
        <!-- Link will be updated by JavaScript to preserve variant parameter -->
        <div><a href="/pages/catalog.html" id="catalog-link">All Products</a></div>
      </div>
    </div>

  <section class="section-pdp">
    <div class="pdp-loading-overlay" id="pdp-loading-overlay">
      <div class="loading-spinner"></div>
    </div>

    <div class="product-detail-container" id="product-detail-container" style="visibility: hidden;">
      <div class="product-detail">
        <!-- Cookware-Inspired Layout -->
        <div class="product-detail-header">
          <div class="product-cookware-layout">
            <!-- Left: Product Image (55%) -->
            <div class="product-image-hero">
              <div class="product-gallery" id="product-gallery" data-sku="">
                <div>
                  <div>
                    <div class="product-gallery-main">
                      <div class="product-gallery-image-wrapper">
                        <img class="product-gallery-main-image" src="" alt="" id="product-gallery-main-image">
                        <button class="product-gallery-zoom-btn" aria-label="Zoom image" id="product-gallery-zoom-btn">
                          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="m21 21-4.35-4.35"/>
                            <path d="M11 8v6M8 11h6"/>
                          </svg>
                        </button>
                      </div>
                    </div>
                    <div class="product-gallery-thumbnails" id="product-gallery-thumbnails">
                      <!-- Thumbnails -->
                    </div>
                  </div>
                </div>
                <!-- Lightbox -->
                <div class="product-gallery-lightbox" id="product-gallery-lightbox">
                  <button class="product-gallery-lightbox-close" aria-label="Close lightbox" id="product-gallery-lightbox-close">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                  </button>
                  <img class="product-gallery-lightbox-image" src="" alt="" id="product-gallery-lightbox-image">
                </div>
              </div>
            </div>

            <!-- Right: Clean Sidebar (45%) -->
            <div class="product-sidebar-clean">
              <!-- Unit 1: Title + SKU -->
              <div class="product-header-clean">
                <h1 id="product-name" class="product-name-clean">Loading...</h1>
                <p id="product-sku" class="product-sku-clean">SKU: Loading...</p>
              </div>

              <!-- Unit 2: Price + Pill -->
              <div class="pricing-display pricing-clean-sidebar" id="pricing-display" data-sku="">
                <div class="current-price-clean">$0.00</div>
                <div class="tier-badge-clean">Loading...</div>
              </div>

              <!-- Unit 3: Quantity + Add to Cart -->
              <div class="purchase-actions-clean">
                <div class="quantity-section-clean">
                  <div class="quantity-label-row">
                    <label for="quantity" class="quantity-label-clean">Quantity</label>
                    <button id="volume-pricing-trigger" class="volume-pricing-trigger" style="display: none;">
                      View Volume Pricing
                    </button>
                  </div>
                  <div class="product-detail-qty-controls">
                    <button class="product-detail-qty-btn" data-action="decrease" aria-label="Decrease quantity">-</button>
                    <input type="number" id="quantity" class="product-detail-quantity-input" value="1" min="1" max="9999">
                    <button class="product-detail-qty-btn" data-action="increase" aria-label="Increase quantity">+</button>
                  </div>
                </div>
                <button id="add-to-cart-btn" class="btn btn-cta add-to-cart-clean">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M5 12h14"></path>
                  </svg>
                  Add to Cart
                </button>
              </div>

              <!-- Volume Pricing Modal - child of sidebar for correct desktop positioning, inline on mobile via CSS -->
              <div id="volume-pricing-modal" class="volume-pricing-modal" style="display: none;">
                <div class="volume-pricing-modal-backdrop"></div>
                <div class="volume-pricing-modal-content">
                  <div class="volume-pricing-modal-header">
                    <h3>Volume Pricing</h3>
                    <button id="volume-pricing-modal-close" class="volume-pricing-modal-close" aria-label="Close modal">
                      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 6L6 18M6 6l12 12"/>
                      </svg>
                    </button>
                  </div>
                  <div class="volume-pricing-modal-body">
                    <table class="volume-pricing-table-modal">
                      <thead>
                        <tr>
                          <th>Quantity</th>
                          <th>Unit Price</th>
                          <th>Savings</th>
                        </tr>
                      </thead>
                      <tbody class="pricing-tiers-modal">
                        <!-- Populated by JS -->
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tabs -->
                <div class="product-detail-content">
                  <!-- Mobile Tab Select -->
                  <div class="product-tabs-mobile">
                    <label for="product-tab-select" class="product-tabs-mobile-label">View:</label>
                    <select id="product-tab-select" class="product-tab-select">
                      <option value="description" selected>Description</option>
                      <option value="specifications">Specifications</option>
                      <option value="availability">Availability</option>
                      <option value="volume-pricing" id="volume-pricing-option" style="display: none;">Volume Pricing</option>
                    </select>
                  </div>
                  
                  <!-- Desktop Tabs -->
                  <div class="product-tabs" role="tablist">
                    <button class="product-tab active" role="tab" aria-selected="true" data-tab="description">Description</button>
                    <button class="product-tab" role="tab" aria-selected="false" data-tab="specifications">Specifications</button>
                    <button class="product-tab" role="tab" aria-selected="false" data-tab="availability">Availability</button>
                    <button class="product-tab" role="tab" aria-selected="false" data-tab="volume-pricing" id="volume-pricing-tab" style="display: none;"><span class="tab-label-long">Volume </span>Pricing</button>
                  </div>

                  <div class="product-tab-panels">
                    <div class="product-tab-panel active" id="tab-description">
                      <p id="product-description-full" class="product-detail-description-text">Loading...</p>
                    </div>
                    <div class="product-tab-panel" id="tab-specifications" hidden>
                      <div id="product-specs" class="product-specs-table"></div>
                    </div>
                    <div class="product-tab-panel" id="tab-availability" hidden>
                      <div class="inventory-status inventory-status-subtle" id="inventory-status" data-sku="">
                        <div>
                          <div>
                            <div class="warehouse-list"></div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="product-tab-panel" id="tab-volume-pricing" hidden>
                      <table class="volume-pricing-table-full">
                        <thead>
                          <tr>
                            <th>Quantity</th>
                            <th>Unit Price</th>
                            <th>Savings</th>
                          </tr>
                        </thead>
                        <tbody class="pricing-tiers">
                          <!-- Populated by JS -->
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>

      </div>
    </div>
  </section>

  </main>

  <footer></footer>

  <script type="module">
    import { decorateBlock } from '../scripts/scripts.js';
    import { acoService } from '../scripts/aco-service.js';
    import { authService } from '../scripts/auth.js';
    import { cleanElementListeners } from '../scripts/utils.js';

    async function loadProductDetail() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const sku = urlParams.get('sku') || 'LBR-D0414F1E';

        // CRITICAL: Wait for auth to initialize before getting user context
        console.log('[PDP] Waiting for auth to initialize...');
        await authService.initialize();
        console.log('[PDP] Auth initialized!');

        // Get user context for pricing
        const currentUser = authService.getCurrentUser();
        console.log('[PDP] Current user object:', currentUser);
        console.log('[PDP] Current user customerGroup:', currentUser?.customerGroup);
        
        const customerGroup = currentUser?.customerGroup || 'US-Retail';
        
        console.log('[PDP] Loading product with user context:', {
          authenticated: authService.isAuthenticated(),
          user: currentUser?.name,
          customerGroup: customerGroup,
          fallbackUsed: !currentUser?.customerGroup
        });

        const [productResult, pricingResult] = await Promise.all([
          acoService.getProduct(sku),
          acoService.getPricing({
            productIds: [sku],
            customerGroup: customerGroup,
            quantity: 1
          })
        ]);

        const product = productResult;
        const pricing = pricingResult.pricing[sku];

        document.getElementById('product-name').textContent = product.name;
        document.getElementById('product-sku').textContent = product.sku;
        
        // Update catalog link to preserve variant parameter
        const catalogLink = document.getElementById('catalog-link');
        const variantParam = new URLSearchParams(window.location.search).get('variant');
        if (catalogLink && variantParam) {
          catalogLink.href = `/pages/catalog.html?variant=${variantParam}`;
        }
        
        // Category name mapping (matches navigation sections)
        const CATEGORY_NAMES = {
          'structural_materials': 'Structural Materials',
          'windows_doors': 'Windows & Doors',
          'fasteners_hardware': 'Fasteners & Hardware',
          'roofing': 'Roofing',
          'drywall': 'Drywall',
          'lumber': 'Lumber',
          'plywood': 'Plywood & Sheathing'
        };
        
        // Update category breadcrumb if product has a category
        const productCategory = product.attributes?.product_category;
        if (productCategory) {
          const categoryBreadcrumb = document.getElementById('category-breadcrumb');
          const categoryName = CATEGORY_NAMES[productCategory] || 'Products';
          const categorySlug = productCategory.replace(/_/g, '-'); // Convert to URL-friendly format
          
          // Preserve variant parameter if present
          const variantParam = new URLSearchParams(window.location.search).get('variant');
          const variantQuery = variantParam ? `&variant=${variantParam}` : '';
          
          if (categoryBreadcrumb) {
            categoryBreadcrumb.innerHTML = `<div><a href="/pages/catalog.html?category=${categorySlug}${variantQuery}">${categoryName}</a></div>`;
          }
        }
        
        // Update breadcrumbs with product name
        const breadcrumbsNav = document.querySelector('.breadcrumbs nav');
        if (breadcrumbsNav) {
          // Add separator
          const separator = document.createElement('span');
          separator.textContent = '/';
          breadcrumbsNav.appendChild(separator);
          
          // Add product name as current page (not a link)
          // No inline styles - inherits from .breadcrumbs nav color
          const productBreadcrumb = document.createElement('span');
          productBreadcrumb.textContent = product.name;
          breadcrumbsNav.appendChild(productBreadcrumb);
        }
        
        const currentPriceEl = document.querySelector('.current-price-clean');
        if (currentPriceEl && pricing) {
          currentPriceEl.textContent = `$${pricing.unitPrice.toFixed(2)}`;
        }
        
        document.getElementById('product-description-full').textContent = product.description || 'No description available.';

        const productGallery = document.getElementById('product-gallery');
        productGallery.setAttribute('data-sku', sku);
        productGallery.productData = product;
        await decorateBlock(productGallery, 'product-gallery');

        const pricingDisplay = document.getElementById('pricing-display');
        console.log('[PDP] Pricing display element:', pricingDisplay);
        console.log('[PDP] Pricing data being passed:', pricing);
        
        pricingDisplay.setAttribute('data-sku', sku);
        pricingDisplay.pricingData = pricing;
        if (currentUser) {
          pricingDisplay.setAttribute('data-user-context', JSON.stringify({
            customerGroup: currentUser.customerGroup
          }));
        }
        
        console.log('[PDP] About to decorate pricing-display block...');
        await decorateBlock(pricingDisplay, 'pricing-display');
        console.log('[PDP] Pricing-display block decorated!');
        
        // Check if volume toggle exists and what its display is
        const volumeToggle = document.getElementById('volume-pricing-toggle');
        console.log('[PDP] Volume toggle after decoration:', {
          element: volumeToggle,
          exists: !!volumeToggle,
          display: volumeToggle?.style.display,
          computedDisplay: volumeToggle ? window.getComputedStyle(volumeToggle).display : 'N/A'
        });

        const inventoryStatus = document.getElementById('inventory-status');
        inventoryStatus.setAttribute('data-sku', sku);
        inventoryStatus.productData = product;
        await decorateBlock(inventoryStatus, 'inventory-status');

        const specsContainer = document.getElementById('product-specs');
        if (product.attributes && Object.keys(product.attributes).length > 0) {
          const table = document.createElement('table');
          const tbody = document.createElement('tbody');
          
          Object.entries(product.attributes).forEach(([key, value]) => {
            const row = document.createElement('tr');
            const keyCell = document.createElement('td');
            keyCell.textContent = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            row.appendChild(keyCell);
            
            const valueCell = document.createElement('td');
            valueCell.textContent = Array.isArray(value) ? value.join(', ') : value;
            row.appendChild(valueCell);
            
            tbody.appendChild(row);
          });
          
          table.appendChild(tbody);
          specsContainer.innerHTML = '';
          specsContainer.appendChild(table);
        } else {
          specsContainer.innerHTML = '<p style="color: var(--color-text-secondary); font-style: italic; margin: 0;">No specifications available for this product.</p>';
        }

        const addToCartBtn = document.getElementById('add-to-cart-btn');
        const cleanBtn = cleanElementListeners(addToCartBtn);
        
        cleanBtn.addEventListener('click', () => {
          const quantity = parseInt(document.getElementById('quantity').value) || 1;
          
          // Close volume pricing modal when adding to cart
          const volumePricingModal = document.getElementById('volume-pricing-modal');
          if (volumePricingModal && volumePricingModal.style.display === 'block') {
            volumePricingModal.style.display = 'none';
          }
          
          window.dispatchEvent(new CustomEvent('addToCart', {
            detail: { sku, quantity, productName: product.name }
          }));
        });

        const quantityInput = document.getElementById('quantity');
        quantityInput.addEventListener('change', (e) => {
          const quantity = parseInt(e.target.value) || 1;
          window.dispatchEvent(new CustomEvent('quantityChanged', {
            detail: { sku, quantity }
          }));
        });

        document.querySelectorAll('.product-detail-qty-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const action = btn.getAttribute('data-action');
            let currentQty = parseInt(quantityInput.value) || 1;
            
            if (action === 'decrease') {
              currentQty = Math.max(1, currentQty - 1);
            } else if (action === 'increase') {
              currentQty = Math.min(9999, currentQty + 1);
            }
            
            quantityInput.value = currentQty;
            
            window.dispatchEvent(new CustomEvent('quantityChanged', {
              detail: { sku, quantity: currentQty }
            }));
          });
        });

        let originalValue = quantityInput.value;
        quantityInput.addEventListener('focus', (e) => {
          originalValue = e.target.value;
          e.target.value = '';
        });
        
        quantityInput.addEventListener('blur', (e) => {
          let qty = parseInt(e.target.value);
          
          if (!e.target.value || isNaN(qty) || qty < 1) {
            e.target.value = originalValue;
            return;
          }
          
          if (qty > 9999) {
            qty = 9999;
            e.target.value = qty;
          }
          
          window.dispatchEvent(new CustomEvent('quantityChanged', {
            detail: { sku, quantity: qty }
          }));
        });

        // Tab functionality - shared function to switch tabs
        const tabs = document.querySelectorAll('.product-tab');
        const panels = document.querySelectorAll('.product-tab-panel');
        const tabSelect = document.getElementById('product-tab-select');

        // Sync mobile select with initially active tab on page load
        if (tabSelect) {
          const initialActiveTab = document.querySelector('.product-tab.active');
          if (initialActiveTab) {
            tabSelect.value = initialActiveTab.dataset.tab;
          }
        }

        function switchTab(tabName) {
          // Update desktop tabs
          tabs.forEach(t => {
            t.classList.remove('active');
            t.setAttribute('aria-selected', 'false');
          });
          
          // Update panels
          panels.forEach(p => {
            p.classList.remove('active');
            p.setAttribute('hidden', '');
          });

          // Activate the selected tab/panel
          const activeTab = document.querySelector(`.product-tab[data-tab="${tabName}"]`);
          if (activeTab) {
            activeTab.classList.add('active');
            activeTab.setAttribute('aria-selected', 'true');
          }
          
          const targetPanel = document.getElementById(`tab-${tabName}`);
          if (targetPanel) {
            targetPanel.classList.add('active');
            targetPanel.removeAttribute('hidden');
          }
          
          // Update mobile select
          if (tabSelect && tabSelect.value !== tabName) {
            tabSelect.value = tabName;
          }
        }

        // Desktop tabs click handler
        tabs.forEach(tab => {
          tab.addEventListener('click', () => {
            switchTab(tab.dataset.tab);
          });
        });

        // Mobile select change handler
        if (tabSelect) {
          tabSelect.addEventListener('change', (e) => {
            switchTab(e.target.value);
          });
        }

        // Sync Volume Pricing visibility between desktop tab and mobile option
        // Watch for changes to the desktop tab visibility
        const volumePricingTab = document.getElementById('volume-pricing-tab');
        const volumePricingOption = document.getElementById('volume-pricing-option');
        
        if (volumePricingTab && volumePricingOption) {
          // Create a MutationObserver to watch for style changes on the tab
          const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
              if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                const tabDisplay = window.getComputedStyle(volumePricingTab).display;
                // Sync the option visibility with the tab visibility
                if (tabDisplay !== 'none') {
                  volumePricingOption.style.display = '';
                } else {
                  volumePricingOption.style.display = 'none';
                }
              }
            });
          });
          
          observer.observe(volumePricingTab, { attributes: true });
          
          // Also check initial state
          const initialDisplay = window.getComputedStyle(volumePricingTab).display;
          if (initialDisplay !== 'none') {
            volumePricingOption.style.display = '';
          }
        }

        // Volume Pricing Popover functionality
        const volumePricingModal = document.getElementById('volume-pricing-modal');
        const volumePricingTrigger = document.getElementById('volume-pricing-trigger');
        const volumePricingModalClose = document.getElementById('volume-pricing-modal-close');

        function openVolumePricingModal() {
          if (volumePricingModal) {
            volumePricingModal.style.display = 'block';
          }
        }

        function closeVolumePricingModal() {
          if (volumePricingModal) {
            volumePricingModal.style.display = 'none';
          }
        }

        if (volumePricingTrigger) {
          volumePricingTrigger.addEventListener('click', (event) => {
            event.stopPropagation();
            
            // Check screen size
            if (window.innerWidth <= 2066) {
              // Mobile/Tablet: Activate the Volume Pricing tab and scroll to it
              const volumePricingTab = document.getElementById('volume-pricing-tab');
              const tabsSection = document.querySelector('.product-detail-content');
              
              if (volumePricingTab) {
                // Trigger the tab click to activate it
                volumePricingTab.click();
                
                // Scroll to the tabs section
                if (tabsSection) {
                  tabsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
              }
            } else {
              // Desktop: Open the modal popover
              openVolumePricingModal();
            }
          });
        }

        if (volumePricingModalClose) {
          volumePricingModalClose.addEventListener('click', closeVolumePricingModal);
        }

        // Close modal when clicking outside, except on quantity controls
        document.addEventListener('click', (e) => {
          if (volumePricingModal && volumePricingModal.style.display === 'block') {
            const modalBackdrop = document.querySelector('.volume-pricing-modal-backdrop');
            const modalContent = document.querySelector('.volume-pricing-modal-content');
            
            // Close if clicking on backdrop (for centered modal in mid-range)
            if (modalBackdrop && e.target === modalBackdrop) {
              closeVolumePricingModal();
              return;
            }
            
            // For popover mode: Check if click is on quantity controls or modal itself
            const quantityInput = document.getElementById('quantity');
            const quantityButtons = document.querySelectorAll('.product-detail-qty-btn');
            const quantitySection = document.querySelector('.quantity-section-clean');
            
            const isClickOnModalContent = modalContent && modalContent.contains(e.target);
            const isClickOnTrigger = volumePricingTrigger && volumePricingTrigger.contains(e.target);
            const isClickOnQuantityInput = quantityInput && quantityInput.contains(e.target);
            const isClickOnQuantityButtons = Array.from(quantityButtons).some(btn => btn.contains(e.target));
            const isClickOnQuantitySection = quantitySection && quantitySection.contains(e.target);
            
            // Close if clicking outside all these elements
            if (!isClickOnModalContent && !isClickOnTrigger && !isClickOnQuantityInput && !isClickOnQuantityButtons && !isClickOnQuantitySection) {
              closeVolumePricingModal();
            }
          }
        });

        // Close popover on Escape key
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && volumePricingModal && volumePricingModal.style.display === 'block') {
            closeVolumePricingModal();
          }
        });

        document.getElementById('product-detail-container').style.visibility = 'visible';
        document.getElementById('pdp-loading-overlay').style.display = 'none';

      } catch (error) {
        console.error('Error loading product:', error);
        document.getElementById('pdp-loading-overlay').innerHTML = '<p>Error loading product details.</p>';
      }
    }

    loadProductDetail();
  </script>
</body>
</html>

