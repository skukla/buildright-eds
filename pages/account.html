<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Critical initialization: BASE_PATH, cart preload, variant detection -->
  <script src="../scripts/critical-init.js"></script>
  <title>Account Dashboard - BuildRight Solutions</title>
  <script src="../scripts/scripts.js" type="module"></script>
  <link rel="stylesheet" href="../styles/styles.css">
  <link rel="stylesheet" href="../styles/dashboards/account-dashboard.css">
</head>
<body class="page-account">
  <!-- Header loaded dynamically from blocks/header/ -->
  <header></header>

  <!-- Main Content -->
  <main>
    <!-- Breadcrumbs -->
    <div class="breadcrumbs">
      <div>
        <div><a href="../index.html">Home</a></div>
      </div>
      <div>
        <div>My Account</div>
      </div>
    </div>

    <!-- Account Dashboard with Sidebar -->
    <section class="section">
      <div class="container">
        <h1 class="page-header">Account Dashboard</h1>

        <div class="account-layout">
          <!-- Sidebar Navigation -->
          <nav class="account-nav">
            <a href="#dashboard" class="account-nav-item active" data-section="dashboard">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                <polyline points="9 22 9 12 15 12 15 22"/>
              </svg>
              Dashboard
            </a>
            <a href="#profile" class="account-nav-item" data-section="profile">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
              </svg>
              Profile
            </a>
            <a href="#orders" class="account-nav-item" data-section="orders">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="8" cy="21" r="1"/>
                <circle cx="19" cy="21" r="1"/>
                <path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/>
              </svg>
              Orders
            </a>
            <a href="#locations" class="account-nav-item" data-section="locations" id="locations-nav-item" hidden>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                <circle cx="12" cy="10" r="3"/>
              </svg>
              Store Locations
            </a>
            <!-- Persona-specific nav items will be added here -->
            <div id="persona-nav-items"></div>
          </nav>

          <!-- Main Content Area -->
          <div id="account-content">
            <!-- Dashboard Section (default) -->
            <div class="account-section active" id="section-dashboard">
              <!-- Company Information -->
              <div class="section-block">
                <h2 class="section-header">Company Information</h2>
                <p class="section-description">View your company details and primary warehouse.</p>
                <div class="card">
                  <div class="card-body">
                    <div id="company-info">
                      <p class="company-info-text">
                        <strong>Company:</strong> 
                        <span id="company-name">Loading...</span>
                        <span id="tier-badge-pill" class="tier-badge-inline">
                          <span id="tier-label-inline">Loading...</span>
                        </span>
                      </p>
                      <p class="company-info-text"><strong>Region:</strong> <span id="company-region">Loading...</span></p>
                      <p class="company-info-text"><strong>Primary Warehouse:</strong> <span id="primary-warehouse">Loading
                    </div>
                  </div>
                </div>
              </div>

              <!-- Quick Actions -->
              <div class="section-block">
                <h2 class="section-header">Quick Actions</h2>
                <p class="section-description">Access frequently used features and manage your account.</p>
                <div class="quick-actions-grid" id="quick-actions-grid">
                  <!-- Quick Actions cards loaded dynamically based on persona -->
                </div>
              </div>
            </div>

            <!-- My Builds Section (Sarah only) -->
            <div class="account-section" id="section-builds">
              <h2 class="section-header">My Builds</h2>
              <p class="section-description">Track your active construction projects and order materials.</p>
              
              <!-- Action Buttons -->
              <div class="builds-action-buttons">
                <a href="/pages/dashboard-templates.html" class="btn btn-cta">+ Order Materials for New Build</a>
              </div>

              <!-- Builds Table -->
              <div id="builds-content">
                <!-- Builds will be loaded here dynamically -->
              </div>
            </div>
            
            <!-- Deliveries Section (Sarah only) -->
            <div class="account-section" id="section-deliveries">
              <h2 class="section-header">Deliveries</h2>
              <p class="section-description">Track scheduled and completed material deliveries.</p>
              
              <!-- Deliveries Table -->
              <div id="deliveries-content">
                <!-- Deliveries will be loaded here dynamically -->
              </div>
            </div>

            <!-- Store Locations Section -->
            <div class="account-section" id="section-locations">
              <h2 class="section-header">Store Locations</h2>
              <p class="section-description">Manage your store locations and set your primary warehouse.</p>
              <div id="company-locations" class="locations-grid"></div>
            </div>

            <!-- Profile Section -->
            <div class="account-section" id="section-profile">
              <h2 class="section-header">Personal Information</h2>
              <p class="section-description">Update your personal details and contact information.</p>
              <div class="card">
                <div class="card-body empty-state-card">
                  <p class="empty-state-title">Profile settings coming soon</p>
                  <p class="empty-state-text">You'll be able to update your information here</p>
                </div>
              </div>
            </div>

            <!-- Orders Section -->
            <div class="account-section" id="section-orders">
              <h2 class="section-header">Order History</h2>
              <p class="section-description">View and track your orders.</p>
              <div id="orders-content">
                <!-- Orders will be loaded here dynamically -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer loaded dynamically from blocks/footer/ -->
  <footer></footer>

  <script type="module">
    import { authService } from '../scripts/auth.js';
    import { getCompanyForPersona } from '../scripts/company-config.js';
    import { getPersona } from '../scripts/persona-config.js';
    
    // Load account info from auth service and persona config
    async function loadAccountInfo() {
      await authService.initialize();
      const currentUser = authService.getCurrentUser();
      
      if (!currentUser) {
        document.getElementById('company-name').textContent = 'Not logged in';
        document.getElementById('company-region').textContent = 'N/A';
        document.getElementById('primary-warehouse').textContent = 'N/A';
        return;
      }
      
      // Get full persona data from currentUser
      const persona = currentUser.persona;
      
      // Company name
      document.getElementById('company-name').textContent = persona?.company || 'Individual';
      
      // Region - Get from persona
      document.getElementById('company-region').textContent = persona?.region || 'Not set';
      
      // Primary Warehouse - Get from persona
      document.getElementById('primary-warehouse').textContent = persona?.primaryWarehouse || 'Not set';
      
      // Account Tier - Display inline with company name
      const customerGroup = currentUser?.customerGroup || 'US-Retail';
      const tierNames = {
        'Production-Builder': 'Production Builder',
        'Trade-Professional': 'Trade Professional',
        'Wholesale-Reseller': 'Wholesale Reseller',
        'Retail-Registered': 'Registered Customer',
        'US-Retail': 'Standard'
      };
      
      document.getElementById('tier-label-inline').textContent = tierNames[customerGroup] || 'Standard';
      
      // Locations - Only show if persona has multi-location company
      const company = getCompanyForPersona(persona);
      const locationsContainer = document.getElementById('company-locations');
      const locationsNavItem = document.getElementById('locations-nav-item');
      
      if (persona?.hasMultipleLocations && company && company.locations && company.locations.length > 1) {
        // Show locations nav item
        locationsNavItem.hidden = false;
        
        // Create location cards
        const locationsHTML = company.locations.map(loc => {
          const primaryCheckmark = loc.isPrimary 
            ? `<svg class="location-primary-icon" fill="currentColor" viewBox="0 0 20 20">
                 <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
               </svg>` 
            : '';
          
          const footer = !loc.isPrimary 
            ? `<div class="card-footer">
                 <button class="btn btn-secondary btn-sm" onclick="alert('Set ${loc.city} as primary location')">Set as Primary</button>
               </div>`
            : '';
          
          return `
            <div class="card">
              <div class="card-body">
                <h3 class="location-card-title">
                  ${loc.city}${primaryCheckmark}
                </h3>
                <p class="location-card-text">${loc.address}</p>
                <p class="location-card-text">${loc.city}, ${loc.state} ${loc.zip}</p>
                <p class="location-card-phone">
                  <svg class="location-card-icon" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                  </svg>
                  ${loc.phone}
                </p>
              </div>
              ${footer}
            </div>
          `;
        }).join('');
        
        locationsContainer.innerHTML = locationsHTML;
      } else {
        // Hide locations nav item
        locationsNavItem.hidden = true;
      }
    }
    
    // Navigation handling
    function initNavigation() {
      const navItems = document.querySelectorAll('.account-nav-item[data-section], .quick-action-nav-item[data-section]');
      const sidebarNavItems = document.querySelectorAll('.account-nav-item[data-section]');
      const sections = document.querySelectorAll('.account-section');
      
      navItems.forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          const sectionId = item.dataset.section;
          
          // Only handle if section exists
          const targetSection = document.getElementById(`section-${sectionId}`);
          if (!targetSection) return;
          
          // Update active state on sidebar only
          sidebarNavItems.forEach(nav => nav.classList.remove('active'));
          
          // If this is a sidebar item, mark it active
          if (item.classList.contains('account-nav-item')) {
            item.classList.add('active');
          } else {
            // If clicked from quick actions, activate corresponding sidebar item
            const correspondingSidebar = document.querySelector(`.account-nav-item[data-section="${sectionId}"]`);
            if (correspondingSidebar) {
              correspondingSidebar.classList.add('active');
            }
          }
          
          // Show selected section
          sections.forEach(section => {
            section.classList.remove('active');
          });
          targetSection.classList.add('active');
        });
      });
    }
    
    // Load Quick Actions cards based on persona
    async function loadQuickActions() {
      await authService.initialize();
      const currentUser = authService.getCurrentUser();
      const quickActionsGrid = document.getElementById('quick-actions-grid');
      
      if (!quickActionsGrid) return;
      
      const persona = currentUser?.persona;
      const cards = [];
      
      // Persona-specific first card
      if (persona?.features?.templates) {
        // Sarah: My Builds card - navigates to builds section
        cards.push(`
          <a href="#builds" class="card quick-action-nav-item" data-section="builds">
            <div class="card-body">
              <h3 class="quick-action-title">My Builds</h3>
              <p class="quick-action-text"><strong id="builds-count">0</strong> active builds</p>
            </div>
          </a>
        `);
        
        // Sarah: Deliveries card - navigates to deliveries section
        cards.push(`
          <a href="#deliveries" class="card quick-action-nav-item" data-section="deliveries">
            <div class="card-body">
              <h3 class="quick-action-title">Deliveries</h3>
              <p class="quick-action-text"><strong id="deliveries-count">0</strong> scheduled this week</p>
            </div>
          </a>
        `);
      } else if (persona?.features?.restockDashboard) {
        // Kevin: Restock Dashboard card - navigates to external dashboard.html
        cards.push(`
          <a href="/pages/dashboard.html" class="card quick-action-card">
            <div class="card-body">
              <h3 class="quick-action-title">Restock Dashboard</h3>
              <p class="quick-action-text">Manage inventory and view smart suggestions.</p>
            </div>
          </a>
        `);
      } else {
        // Marcus/Lisa/David/Others: Saved Projects
        cards.push(`
          <a href="project-selector.html" class="card quick-action-card">
            <div class="card-body">
              <h3 class="quick-action-title">Saved Projects</h3>
              <p class="quick-action-text">Access your frequently used project types.</p>
            </div>
          </a>
        `);
      }
      
      // Standard cards for everyone - Orders (links to orders section)
      cards.push(`
        <a href="#orders" class="card quick-action-nav-item" data-section="orders">
          <div class="card-body">
            <h3 class="quick-action-title">Orders</h3>
            <p class="quick-action-text">Track your orders and view order history.</p>
          </div>
        </a>
      `);
      
      // Standard cards for everyone - Account Settings
      cards.push(`
        <a href="#" class="card quick-action-card" onclick="alert('Account settings coming soon!'); return false;">
          <div class="card-body">
            <h3 class="quick-action-title">Account Settings</h3>
            <p class="quick-action-text">Manage your preferences and information.</p>
          </div>
        </a>
      `);
      
      quickActionsGrid.innerHTML = cards.join('');
    }
    
    // Load persona-specific navigation items
    async function loadPersonaNav() {
      await authService.initialize();
      const currentUser = authService.getCurrentUser();
      
      if (!currentUser) return;
      
      const persona = currentUser.persona;
      const personaNavContainer = document.getElementById('persona-nav-items');
      const navItems = [];
      
      // Sarah: My Builds & Deliveries (Phase 6A)
      if (persona?.features?.templates) {
        navItems.push(`
          <a href="#builds" class="account-nav-item" data-section="builds">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
              <polyline points="9 22 9 12 15 12 15 22"/>
            </svg>
            My Builds
          </a>
        `);
        navItems.push(`
          <a href="#deliveries" class="account-nav-item" data-section="deliveries">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <rect x="1" y="3" width="15" height="13"/>
              <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/>
              <circle cx="5.5" cy="18.5" r="2.5"/>
              <circle cx="18.5" cy="18.5" r="2.5"/>
            </svg>
            Deliveries
          </a>
        `);
      }
      
      // Kevin: Restock Dashboard (links to /pages/dashboard.html)
      if (persona?.features?.restockDashboard) {
        navItems.push(`
          <a href="/pages/dashboard.html" class="account-nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <ellipse cx="12" cy="5" rx="9" ry="3"/>
              <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/>
              <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
            </svg>
            Restock Dashboard
          </a>
        `);
      }
      
      // Marcus/Lisa: Project Builder
      if (persona?.features?.projectWizard || persona?.features?.packageBuilder) {
        navItems.push(`
          <a href="builder.html" class="account-nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
            </svg>
            Project Builder
          </a>
        `);
      }
      
      if (navItems.length > 0) {
        personaNavContainer.innerHTML = navItems.join('');
      }
    }

    // Format date helper
    const formatDate = (dateString) => {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
      });
    };
    
    // Render orders table (shared for both templates and orders)
    function renderOrdersTable(orders, emptyTitle, emptyText) {
      if (orders.length === 0) {
        return `
          <div class="card">
            <div class="card-body empty-state-card">
              <p class="empty-state-title">${emptyTitle}</p>
              <p class="empty-state-text">${emptyText}</p>
            </div>
          </div>
        `;
      }
      
      return `
        <div class="orders-table-wrapper">
          <table class="orders-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Order / Build</th>
                <th>Items</th>
                <th>Total</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${orders.map(order => `
                <tr>
                  <td data-label="Date" class="order-date">${formatDate(order.timestamp)}</td>
                  <td data-label="Order / Build">
                    <div class="order-id">${order.orderID}</div>
                    ${order.buildName ? `<div class="order-project-name">${order.buildName}</div>` : ''}
                    ${order.projectName ? `<div class="order-project-name">${order.projectName}</div>` : ''}
                    ${order.phase ? `<div class="order-template-details">${order.phase} Phase</div>` : ''}
                    ${order.templateDetails ? `<div class="order-template-details">${order.templateDetails}</div>` : ''}
                  </td>
                  <td data-label="Items">
                    <div class="order-items">
                      <span class="order-items-count">${order.itemCount} items</span>
                    </div>
                  </td>
                  <td data-label="Total" class="order-total">$${order.total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                  <td data-label="Status">
                    <span class="order-status ${order.status.toLowerCase().replace(/\s+/g, '-')}">${order.status}</span>
                  </td>
                  <td data-label="Actions">
                    <div class="order-actions">
                      ${order.type === 'build-order'
                        ? `<button class="btn btn-secondary btn-sm" onclick="alert('View order: ${order.orderID}')">View Details</button>
                           <button class="btn btn-secondary btn-sm" onclick="alert('Track delivery: ${order.orderID}')">Track Delivery</button>`
                        : order.type === 'template' 
                          ? `<a href="/pages/bom-review.html" class="btn btn-secondary btn-sm">View BOM</a>
                             <a href="/pages/build-configurator.html" class="btn btn-primary btn-sm">Edit Build</a>`
                          : `<button class="btn btn-secondary btn-sm">View Details</button>
                             <button class="btn btn-primary btn-sm">Reorder</button>`
                      }
                    </div>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }
    
    // Load builds (Sarah only)
    async function loadBuilds() {
      await authService.initialize();
      const currentUser = authService.getCurrentUser();
      const buildsContainer = document.getElementById('builds-content');
      
      if (!buildsContainer) return;
      
      const persona = currentUser?.persona;
      
      // Only load builds for Sarah
      if (!persona?.features?.templates) return;
      
      const builds = [
        {
          buildId: 'BUILD-2024-001',
          timestamp: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
          projectName: 'Desert Ridge Lot 12',
          templateName: 'The Phoenix (Bonus Room)',
          itemCount: 847,
          total: 234567.89,
          status: 'Partially Ordered',
          type: 'build',
          phasesOrdered: ['Foundation', 'Framing'],
          phasesRemaining: ['Envelope', 'Interior Finish'],
          orderCount: 2
        },
        {
          buildId: 'BUILD-2024-002',
          timestamp: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
          projectName: 'Desert Ridge Lot 15',
          templateName: 'The Prescott',
          itemCount: 623,
          total: 187234.50,
          status: 'Configured',
          type: 'build',
          phasesOrdered: [],
          phasesRemaining: ['Foundation', 'Framing', 'Envelope', 'Interior Finish'],
          orderCount: 0
        },
        {
          buildId: 'BUILD-2024-003',
          timestamp: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(),
          projectName: 'Sunset Valley Lot 8',
          templateName: 'The Tucson',
          itemCount: 791,
          total: 219876.23,
          status: 'Fully Ordered',
          type: 'build',
          phasesOrdered: ['Foundation', 'Framing', 'Envelope', 'Interior Finish'],
          phasesRemaining: [],
          orderCount: 4
        }
      ];
      
      // Sort by date (newest first)
      builds.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      
      // Update builds count in quick actions
      const buildsCountEl = document.getElementById('builds-count');
      if (buildsCountEl) {
        buildsCountEl.textContent = builds.filter(b => b.status !== 'Fully Ordered').length;
      }
      
      buildsContainer.innerHTML = renderBuildsTable(builds);
    }
    
    // Render builds table
    function renderBuildsTable(builds) {
      if (builds.length === 0) {
        return `
          <div class="card">
            <div class="card-body empty-state-card">
              <p class="empty-state-title">No builds yet</p>
              <p class="empty-state-text">Start your first build by selecting a template.</p>
            </div>
          </div>
        `;
      }
      
      return `
        <div class="orders-table-wrapper">
          <table class="orders-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Build</th>
                <th>Progress</th>
                <th>Total</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${builds.map(build => `
                <tr>
                  <td data-label="Date" class="order-date">${formatDate(build.timestamp)}</td>
                  <td data-label="Build">
                    <div class="order-project-name">${build.projectName}</div>
                    <div class="order-template-details">${build.templateName}</div>
                  </td>
                  <td data-label="Progress">
                    <div class="order-progress">
                      ${build.phasesOrdered.length} of ${build.phasesOrdered.length + build.phasesRemaining.length} phases ordered
                    </div>
                  </td>
                  <td data-label="Total" class="order-total">$${build.total.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</td>
                  <td data-label="Status">
                    <span class="order-status ${build.status.toLowerCase().replace(/\s+/g, '-')}">${build.status}</span>
                  </td>
                  <td data-label="Actions">
                    <div class="order-actions">
                      ${build.status === 'Configured' || build.status === 'Partially Ordered'
                        ? `<a href="/pages/build-configurator.html?id=${build.buildId}" class="btn btn-primary btn-sm">Order Materials</a>`
                        : `<a href="/pages/build-detail.html?id=${build.buildId}" class="btn btn-secondary btn-sm">View Details</a>`
                      }
                    </div>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }
    
    // Load deliveries (Sarah only)
    async function loadDeliveries() {
      await authService.initialize();
      const currentUser = authService.getCurrentUser();
      const deliveriesContainer = document.getElementById('deliveries-content');
      
      if (!deliveriesContainer) return;
      
      const persona = currentUser?.persona;
      
      // Only load deliveries for Sarah
      if (!persona?.features?.templates) return;
      
      const deliveries = [
        {
          deliveryId: 'DEL-2024-001',
          deliveryDate: new Date(Date.now() + 1 * 24 * 60 * 60 * 1000).toISOString(),
          buildName: 'Desert Ridge Lot 12',
          orderID: 'ORD-1234',
          phase: 'Framing',
          location: '123 Desert Ridge Blvd, Phoenix, AZ',
          itemCount: 245,
          status: 'Scheduled'
        },
        {
          deliveryId: 'DEL-2024-002',
          deliveryDate: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000).toISOString(),
          buildName: 'Desert Ridge Lot 12',
          orderID: 'ORD-1235',
          phase: 'Envelope',
          location: '123 Desert Ridge Blvd, Phoenix, AZ',
          itemCount: 182,
          status: 'Scheduled'
        },
        {
          deliveryId: 'DEL-2024-003',
          deliveryDate: new Date(Date.now() + 4 * 24 * 60 * 60 * 1000).toISOString(),
          buildName: 'Sunset Valley Lot 8',
          orderID: 'ORD-1240',
          phase: 'Interior Finish',
          location: '456 Sunset Valley Dr, Phoenix, AZ',
          itemCount: 156,
          status: 'Scheduled'
        },
        {
          deliveryId: 'DEL-2024-004',
          deliveryDate: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(),
          buildName: 'Desert Ridge Lot 12',
          orderID: 'ORD-1230',
          phase: 'Foundation',
          location: '123 Desert Ridge Blvd, Phoenix, AZ',
          itemCount: 120,
          status: 'Delivered'
        }
      ];
      
      // Sort by date (soonest first)
      deliveries.sort((a, b) => new Date(a.deliveryDate) - new Date(b.deliveryDate));
      
      // Update deliveries count in quick actions (upcoming this week)
      const deliveriesCountEl = document.getElementById('deliveries-count');
      if (deliveriesCountEl) {
        const now = new Date();
        const weekFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
        const thisWeek = deliveries.filter(d => {
          const delDate = new Date(d.deliveryDate);
          return delDate >= now && delDate <= weekFromNow && d.status === 'Scheduled';
        });
        deliveriesCountEl.textContent = thisWeek.length;
      }
      
      deliveriesContainer.innerHTML = renderDeliveriesTable(deliveries);
    }
    
    // Render deliveries table
    function renderDeliveriesTable(deliveries) {
      if (deliveries.length === 0) {
        return `
          <div class="card">
            <div class="card-body empty-state-card">
              <p class="empty-state-title">No deliveries scheduled</p>
              <p class="empty-state-text">Deliveries will appear here after you order materials.</p>
            </div>
          </div>
        `;
      }
      
      return `
        <div class="orders-table-wrapper">
          <table class="orders-table">
            <thead>
              <tr>
                <th>Delivery Date</th>
                <th>Build / Order</th>
                <th>Phase</th>
                <th>Location</th>
                <th>Items</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${deliveries.map(delivery => `
                <tr>
                  <td data-label="Delivery Date" class="order-date">${formatDate(delivery.deliveryDate)}</td>
                  <td data-label="Build / Order">
                    <div class="order-project-name">${delivery.buildName}</div>
                    <div class="order-id">${delivery.orderID}</div>
                  </td>
                  <td data-label="Phase">
                    <span class="order-phase">${delivery.phase}</span>
                  </td>
                  <td data-label="Location">
                    <div class="order-location">
                      ${delivery.location}
                    </div>
                  </td>
                  <td data-label="Items">
                    <div class="order-items">
                      <span class="order-items-count">${delivery.itemCount} items</span>
                    </div>
                  </td>
                  <td data-label="Status">
                    <span class="order-status ${delivery.status.toLowerCase()}">${delivery.status}</span>
                  </td>
                  <td data-label="Actions">
                    <div class="order-actions">
                      ${delivery.status === 'Scheduled'
                        ? `<button class="btn btn-secondary btn-sm" onclick="alert('Track delivery: ${delivery.deliveryId}')">Track</button>
                           <button class="btn btn-secondary btn-sm" onclick="alert('Reschedule: ${delivery.deliveryId}')">Reschedule</button>`
                        : `<button class="btn btn-secondary btn-sm" onclick="alert('View details: ${delivery.deliveryId}')">View Details</button>`
                      }
                    </div>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }
    
    // Load orders
    async function loadOrders() {
      await authService.initialize();
      const currentUser = authService.getCurrentUser();
      const ordersContainer = document.getElementById('orders-content');
      
      if (!ordersContainer) return;
      
      const persona = currentUser?.persona;
      
      // Load orders from localStorage
      let orders = [];
      try {
        orders = JSON.parse(localStorage.getItem('buildright_orders') || '[]');
      } catch (e) {
        console.error('Error loading orders:', e);
      }
      
      // For Sarah, add build/phase context to orders
      if (persona?.features?.templates) {
        // Mock orders with build context
        const buildsOrders = [
          {
            orderID: 'ORD-1234',
            timestamp: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(),
            buildName: 'Desert Ridge Lot 12',
            phase: 'Framing',
            itemCount: 245,
            total: 45230.00,
            status: 'Delivered',
            type: 'build-order'
          },
          {
            orderID: 'ORD-1230',
            timestamp: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000).toISOString(),
            buildName: 'Desert Ridge Lot 12',
            phase: 'Foundation',
            itemCount: 120,
            total: 32450.00,
            status: 'Delivered',
            type: 'build-order'
          },
          {
            orderID: 'ORD-1240',
            timestamp: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
            buildName: 'Sunset Valley Lot 8',
            phase: 'Interior Finish',
            itemCount: 156,
            total: 28900.00,
            status: 'Processing',
            type: 'build-order'
          }
        ];
        orders = [...buildsOrders, ...orders];
      }
      
      // Sort by date (newest first)
      orders.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      
      ordersContainer.innerHTML = renderOrdersTable(
        orders,
        'No orders yet',
        'When you make a purchase, it will appear here.'
      );
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      await loadAccountInfo();
      await loadQuickActions();
      await loadPersonaNav();
      await loadBuilds();
      await loadDeliveries();
      await loadOrders();
      initNavigation();
    });
  </script>
</body>
</html>
