<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="scripts/base-url.js"></script>
  <script>
    // Set base tag immediately before any resources load
    (function() {
      const pathname = window.location.pathname;
      const isGitHubPages = pathname.startsWith('/buildright-eds/');
      const basePath = isGitHubPages ? '/buildright-eds/' : '/';
      const baseTag = document.createElement('base');
      baseTag.href = window.location.origin + basePath;
      document.head.insertBefore(baseTag, document.head.firstChild);
      window.BASE_PATH = basePath;
    })();
  </script>
  <title>Project Builder - BuildRight Solutions</title>
  <link rel="stylesheet" href="styles/base.css">
  <link rel="stylesheet" href="styles/components.css">
  <link rel="stylesheet" href="styles/utilities.css">
  <link rel="stylesheet" href="blocks/header/header.css">
  <style>
    .wizard-container {
      max-width: 1400px;
      margin: 2rem auto;
      padding: 0 var(--section-padding-horizontal);
    }

    .wizard-layout {
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 2rem;
      align-items: start;
    }

    .wizard-main {
      min-width: 0;
    }

    .wizard-progress {
      display: flex;
      justify-content: space-between;
      margin-bottom: 3rem;
      position: relative;
      background: var(--color-surface);
      padding: var(--spacing-large) var(--spacing-medium);
      border-radius: var(--shape-border-radius-4);
      border: 1px solid var(--color-border);
      border-top: 4px solid var(--color-accent-500);
      box-shadow: var(--shape-shadow-1);
    }

    .wizard-progress::before {
      content: '';
      position: absolute;
      top: calc(var(--spacing-large) + 20px);
      left: var(--line-start, 0);
      width: calc(var(--line-end, 100%) - var(--line-start, 0));
      height: 2px;
      background: var(--color-border);
      z-index: 0;
    }

    .wizard-progress-bar {
      position: absolute;
      top: calc(var(--spacing-large) + 20px);
      left: 0;
      height: 2px;
      background: var(--color-brand-500);
      transition: none;
      z-index: 1;
      opacity: 0;
    }
    
    .wizard-progress-bar.initialized {
      transition: width 0.3s ease, left 0.3s ease;
      opacity: 1;
    }

    .wizard-step {
      position: relative;
      z-index: 2;
      text-align: center;
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .wizard-step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: white;
      border: 2px solid var(--color-border);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
      font-weight: 600;
      color: var(--color-text-secondary);
      transition: all 0.3s ease;
      position: relative;
      z-index: 3;
    }

    .wizard-step.active .wizard-step-circle {
      background: var(--color-accent-500);
      border-color: var(--color-accent-500);
      color: white;
    }

    .wizard-step.completed .wizard-step-circle {
      background: var(--color-brand-400);
      border-color: var(--color-brand-400);
      color: white;
      cursor: pointer;
    }

    .wizard-step.completed:hover .wizard-step-circle {
      background: var(--color-brand-500);
      border-color: var(--color-brand-500);
      transform: scale(1.1);
      box-shadow: var(--shape-shadow-2);
    }

    .wizard-step.future {
      opacity: 0.5;
    }

    .wizard-step.future .wizard-step-circle {
      cursor: not-allowed;
    }

    .wizard-step-label {
      font: var(--type-body-2-default-font);
      color: var(--color-text-secondary);
      margin-top: 0.75rem;
      margin-bottom: 0;
      line-height: 1.4;
    }

    .wizard-step.active .wizard-step-label {
      color: var(--color-accent-500);
      font-weight: 600;
    }

    .wizard-step.completed .wizard-step-label {
      cursor: pointer;
    }

    .wizard-content {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--shape-border-radius-4);
      padding: 2rem;
      box-shadow: var(--shape-shadow-2);
    }

    .wizard-step-content {
      display: none;
    }

    .wizard-step-content.active {
      display: block;
    }

    .wizard-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 2rem;
    }

    .wizard-option {
      border: 2px solid var(--color-border);
      border-radius: var(--shape-border-radius-3);
      padding: 1.5rem;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
      background: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }

    .wizard-option:hover {
      border-color: var(--color-brand-500);
      background: rgba(15, 91, 167, 0.02); /* --color-brand-500 with 2% opacity */
      transform: translateY(-2px);
      box-shadow: var(--shape-shadow-2);
    }

    .wizard-option:hover .wizard-icon {
      color: var(--color-brand-500);
      transform: scale(1.05);
    }

    .wizard-option.selected {
      border-color: var(--color-brand-500);
      border-width: 3px;
      background: rgba(15, 91, 167, 0.08); /* --color-brand-500 with 8% opacity */
      box-shadow: var(--shape-shadow-1);
    }

    .wizard-option.selected .wizard-icon {
      color: var(--color-accent-500);
    }

    .wizard-icon {
      width: 56px;
      height: 56px;
      color: var(--color-text-secondary);
      transition: all 0.2s ease;
    }

    .wizard-option h3 {
      margin: 0 0 0.5rem;
      font-size: 1.125rem; /* Extract from --type-button-1-font */
      color: var(--color-text);
    }

    .wizard-option p {
      margin: 0;
      font: var(--type-body-2-default-font);
      color: var(--color-text-secondary);
    }

    /* Photo-based wizard options for Steps 1 & 2 */
    .wizard-option-photo {
      position: relative;
      border-radius: var(--shape-border-radius-3);
      overflow: hidden;
      cursor: pointer;
      height: 240px;
      transition: all 0.3s ease;
      border: 3px solid transparent;
      background-size: cover;
      background-position: center;
      display: flex;
      align-items: flex-end;
    }

    .wizard-option-photo:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.2);
      border-color: var(--color-brand-500);
    }

    .wizard-option-photo.selected {
      border-color: var(--color-brand-500);
      box-shadow: 0 8px 20px rgba(15, 91, 167, 0.3);
    }

    .wizard-option-photo.selected::after {
      content: '‚úì';
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 32px;
      height: 32px;
      background: var(--color-brand-500);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.125rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      z-index: 3;
    }

    .wizard-photo-overlay {
      position: relative;
      width: 100%;
      background: linear-gradient(to top, rgba(0, 0, 0, 0.85) 0%, rgba(0, 0, 0, 0.5) 60%, transparent 100%);
      padding: 2rem 1.5rem 1.5rem;
      color: white;
      z-index: 2;
    }

    .wizard-option-photo h3 {
      font-size: 1.375rem;
      color: white;
      margin: 0 0 0.5rem 0;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
      font-weight: 600;
    }

    .wizard-option-photo p {
      font-size: 0.9375rem;
      color: rgba(255, 255, 255, 0.95);
      margin: 0;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
    }

    /* Photo grid for Steps 1 & 2 */
    .wizard-options-photo {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-top: 2rem;
    }

    .wizard-navigation {
      display: flex;
      justify-content: space-between;
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 1px solid var(--color-border);
    }

    .wizard-results {
      text-align: center;
    }

    .wizard-results h2 {
      margin-bottom: 1rem;
    }

    .wizard-results p {
      color: var(--color-text-secondary);
      margin-bottom: 2rem;
    }

    /* Sidebar Styles */
    .wizard-sidebar {
      position: sticky;
      top: 2rem;
    }

    .sidebar-card {
      background: var(--color-surface-hover);
      border: 1px solid var(--color-border);
      border-left: 4px solid var(--color-accent-500);
      border-radius: var(--shape-border-radius-4);
      padding: 1.5rem;
      box-shadow: var(--shape-shadow-2);
    }

    .sidebar-title {
      margin: 0 0 1rem;
      font-size: 1.125rem; /* Extract from --type-button-1-font */
      color: var(--color-text);
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--color-border);
    }

    .sidebar-content {
      font-size: var(--font-size-sm);
    }

    .sidebar-selections {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .sidebar-selection {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .sidebar-selection-label {
      font-weight: 600;
      color: var(--color-text-secondary);
      font: var(--type-details-caption-1-font);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .sidebar-selection-value {
      color: var(--color-text);
      font-weight: 500;
    }

    .sidebar-empty {
      color: var(--color-text-secondary);
      font-style: italic;
      margin: 0;
      text-align: center;
      padding: 1rem 0;
    }

    .sidebar-divider {
      height: 1px;
      background: var(--color-border);
      margin: 1rem 0;
    }

    .sidebar-estimate {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .sidebar-stat {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .sidebar-stat-label {
      color: var(--color-text-secondary);
      font-weight: 500;
    }

    .sidebar-stat-value {
      color: var(--color-text);
      font-weight: 600;
    }

    .sidebar-stat-total {
      padding-top: 0.75rem;
      border-top: 1px solid var(--color-border);
      margin-top: 0.5rem;
    }

    .sidebar-stat-total .sidebar-stat-label {
      color: var(--color-text);
      font-weight: 600;
      font: var(--type-body-1-default-font);
    }

      .sidebar-stat-total .sidebar-stat-value {
      color: var(--color-brand-500);
      font-weight: 700;
      font-size: 1.125rem; /* Extract from --type-button-1-font */
    }

    .sidebar-actions {
      margin-top: 1rem;
    }

    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: var(--shape-border-radius-4);
      padding: 2rem;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: var(--shape-shadow-3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--color-border);
    }

    .modal-title {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 700;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--color-text-secondary);
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      color: var(--color-text);
    }

    .saved-projects-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }

    .saved-project-item {
      border: 1px solid var(--color-border);
      border-radius: var(--shape-border-radius-3);
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s;
    }

    .saved-project-item:hover {
      border-color: var(--color-brand-500);
      box-shadow: var(--shape-shadow-1);
    }

    .saved-project-info {
      flex: 1;
    }

    .saved-project-name {
      font-weight: 600;
      margin-bottom: 0.25rem;
      color: var(--color-text);
    }

    .saved-project-meta {
      font: var(--type-details-caption-1-font);
      color: var(--color-text-secondary);
    }

    .saved-project-actions {
      display: flex;
      gap: 0.5rem;
    }

    .btn-icon {
      padding: 0.5rem;
      min-width: auto;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .empty-state {
      text-align: center;
      padding: 2rem;
      color: var(--color-text-secondary);
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    /* Toast Notification Styles */
    .toast {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: white;
      border: 1px solid var(--color-border);
      border-radius: var(--shape-border-radius-3);
      padding: 1rem 1.5rem;
      box-shadow: var(--shape-shadow-3);
      z-index: 2000;
      display: flex;
      align-items: center;
      gap: 1rem;
      min-width: 300px;
      max-width: 500px;
      animation: slideIn 0.3s ease;
    }

    .toast.success {
      border-left: 4px solid var(--color-positive-500);
    }

    .toast.error {
      border-left: 4px solid var(--color-negative-500);
    }

    .toast.info {
      border-left: 4px solid var(--color-brand-500);
    }

    .toast-icon {
      font-size: 1.5rem;
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
      color: var(--color-text);
    }

    .toast-message {
      font: var(--type-body-2-default-font);
      color: var(--color-text-secondary);
    }

    .toast-close {
      background: none;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      color: var(--color-text-secondary);
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Error Message Styles */
    .error-message {
      background: var(--color-negative-100);
      border: 1px solid var(--color-negative-500);
      border-radius: var(--shape-border-radius-3);
      padding: 1rem;
      margin-top: 1rem;
      color: var(--color-negative-700);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .error-message-icon {
      font-size: 1.25rem;
    }

    .form-input:invalid {
      border-color: var(--color-negative-500);
    }

    .form-input:focus:invalid {
      outline-color: var(--color-negative-500);
    }

    /* Section Header Styles */
    .wizard-step-content h2 {
      background: var(--color-surface);
      padding: var(--spacing-medium) var(--spacing-large);
      margin: calc(-2rem - 1px) calc(-2rem - 1px) 0;
      border-bottom: 2px solid var(--color-border);
      border-left: 4px solid var(--color-accent-500);
      border-radius: var(--shape-border-radius-4) var(--shape-border-radius-4) 0 0;
      font: var(--type-headline-2-font);
      color: var(--color-text);
    }
    
    .wizard-step-content h2 + .step-sub-progress {
      margin-top: var(--spacing-large);
    }
    
    .wizard-step-content h2 + p {
      margin-top: var(--spacing-large);
    }

    /* Sub-Step Indicator Styles */
    .step-sub-progress {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin: var(--spacing-large) 0;
      padding: 0 var(--spacing-large);
    }

    .step-sub-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--color-border);
      transition: all 0.2s ease;
    }

    .step-sub-dot.active {
      background: var(--color-accent-500);
      transform: scale(1.3);
    }

    .step-sub-dot.completed {
      background: var(--color-brand-400);
    }


    .conditional-options {
      display: none;
    }

    .conditional-options.active {
      display: grid;
    }

    /* Responsive Layout */
    @media (max-width: 1023px) {
      .wizard-layout {
        grid-template-columns: 1fr 280px;
      }
    }

    @media (max-width: 767px) {
      .wizard-layout {
        grid-template-columns: 1fr;
      }

      .wizard-sidebar {
        position: static;
        order: -1;
      }

      .sidebar-card {
        margin-bottom: 2rem;
      }

      .wizard-icon {
        width: 48px;
        height: 48px;
      }

      .wizard-options {
        grid-template-columns: 1fr;
      }

      .wizard-options-photo {
        grid-template-columns: 1fr;
      }

      .wizard-option-photo {
        height: 200px;
      }
    }

    /* Enhanced Bundle Display Styles */
    .project-bundle {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--shape-border-radius-4);
      padding: 2rem;
    }

    .bundle-header {
      margin-bottom: 2rem;
    }

    .bundle-badge {
      display: inline-block;
      background: var(--color-accent);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: var(--shape-border-radius-2);
      font: var(--type-details-caption-1-font);
      font-weight: 600;
      margin-bottom: 1rem;
    }

    .bundle-title {
      margin: 0 0 0.5rem;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--color-text);
    }

    .bundle-subtitle {
      margin: 0;
      color: var(--color-text-secondary);
      font-size: var(--font-size-sm);
    }

    .bundle-summary {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.5rem;
      background: var(--color-background);
      border-radius: var(--shape-border-radius-3);
      margin-bottom: 2rem;
    }

    .bundle-total-label {
      font: var(--type-body-2-default-font);
      color: var(--color-text-secondary);
      margin-bottom: 0.5rem;
    }

    .bundle-total-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--color-brand-500);
    }

    .bundle-products {
      margin-bottom: 2rem;
    }

    .bundle-products-title {
      font-size: 1.125rem; /* Extract from --type-button-1-font */
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--color-text);
    }

    .bundle-category-section {
      margin-bottom: 1.5rem;
      border: 1px solid var(--color-border);
      border-radius: var(--shape-border-radius-3);
      overflow: hidden;
    }

    .bundle-category-section.excluded {
      opacity: 0.5;
    }

    .category-toggle {
      width: 100%;
      padding: 1rem 1.5rem;
      background: var(--color-background);
      border: none;
      border-bottom: 1px solid var(--color-border);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      color: var(--color-text);
      transition: background-color 0.2s;
    }

    .category-toggle:hover {
      background: var(--color-surface);
    }

    .category-toggle.excluded {
      background: var(--color-background);
      opacity: 0.6;
    }

    .category-checkbox {
      width: 20px;
      height: 20px;
      margin-right: 1rem;
      cursor: pointer;
      accent-color: var(--color-brand-500);
    }

    .category-name {
      flex: 1;
      text-align: left;
    }

    .category-count {
      margin: 0 1rem;
      color: var(--color-text-secondary);
      font-weight: 400;
      font-size: var(--font-size-sm);
    }

    .category-price {
      margin-right: 1rem;
      font-weight: 600;
      color: var(--color-brand-500);
    }

    .toggle-icon {
      transition: transform 0.2s;
      font-size: var(--font-size-sm);
      display: none; /* Hide expand/collapse icon */
    }

    .category-items {
      padding: 1rem;
      background: var(--color-surface);
    }

    .category-items.excluded {
      display: none !important;
    }

    /* Component Toggles Section */
    .component-toggles {
      background: var(--color-background);
      border: 1px solid var(--color-border);
      border-radius: var(--shape-border-radius-3);
      padding: 1.5rem;
      margin-bottom: 2rem;
    }

    .component-toggles-title {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--color-text);
    }

    .component-toggle-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--color-border);
    }

    .component-toggle-item:last-child {
      border-bottom: none;
      padding-top: 0.75rem;
      margin-top: 0.5rem;
      border-top: 2px solid var(--color-border);
      font-weight: 600;
    }

    .component-toggle-label {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      cursor: pointer;
      flex: 1;
    }

    .component-toggle-checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: var(--color-brand-500);
    }

    .component-toggle-price {
      font-weight: 600;
      color: var(--color-text);
    }

    .component-toggle-item:last-child .component-toggle-price {
      color: var(--color-brand-500);
      font-size: 1.125rem;
    }

    .products-table {
      width: 100%;
      border-collapse: collapse;
    }

    .products-table thead {
      background: var(--color-background);
      border-bottom: 2px solid var(--color-border);
    }

    .products-table th {
      padding: 0.75rem;
      text-align: left;
      font-weight: 600;
      font-size: var(--font-size-sm);
      color: var(--color-text);
    }

    .products-table td {
      padding: 1rem 0.75rem;
      border-bottom: 1px solid var(--color-border);
      vertical-align: top;
    }

    .products-table tbody tr:hover {
      background: var(--color-background);
    }

    .product-info {
      min-width: 200px;
    }

    .product-name {
      font-weight: 600;
      margin-bottom: 0.25rem;
      color: var(--color-text);
    }

    .product-reason {
      font: var(--type-details-caption-1-font);
      color: var(--color-accent-500);
      font-style: italic;
    }

    .why-item-tooltip {
      cursor: help;
      margin-left: 0.25rem;
      color: var(--color-brand-500);
      font-weight: 600;
    }

    .product-sku {
      font: normal normal 400 0.75rem/1.33 var(--type-font-family-base);
      color: var(--color-text-secondary);
    }

    .product-thumbnail {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: var(--shape-border-radius-2);
      border: 1px solid var(--color-border);
    }

    .stock-status {
      font: var(--type-details-caption-1-font);
      font-weight: 600;
      padding: 0.25rem 0.5rem;
      border-radius: var(--shape-border-radius-2);
      display: inline-block;
    }

    .stock-status.stock-in {
      background: var(--color-positive-100);
      color: var(--color-positive-700);
    }

    .stock-status.stock-low {
      background: var(--color-warning-100);
      color: var(--color-warning-700);
    }

    .stock-status.stock-out {
      background: var(--color-negative-100);
      color: var(--color-negative-700);
    }

    .quantity-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .qty-btn {
      width: 28px;
      height: 28px;
      border: 1px solid var(--color-border);
      background: var(--color-background);
      border-radius: var(--shape-border-radius-2);
      cursor: pointer;
      font-weight: 600;
      color: var(--color-text);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .qty-btn:hover {
      background: var(--color-brand-500);
      color: white;
      border-color: var(--color-brand-500);
    }

    .qty-value {
      min-width: 30px;
      text-align: center;
      font-weight: 600;
    }

    .product-unit-price,
    .product-subtotal {
      text-align: right;
      font-weight: 600;
      color: var(--color-text);
    }

    .bundle-actions {
      text-align: center;
      padding-top: 1.5rem;
      border-top: 1px solid var(--color-border);
    }

    /* Tooltip Styles */
    .tooltip-wrapper {
      position: relative;
      display: inline-block;
    }

    .tooltip-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--color-brand-100);
      color: var(--color-brand-600);
      font-size: 0.75rem;
      font-weight: 600;
      cursor: help;
      margin-left: 0.5rem;
      vertical-align: middle;
      transition: all 0.2s ease;
    }

    .tooltip-icon:hover {
      background: var(--color-brand-500);
      color: white;
    }

    .tooltip-content {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      margin-bottom: 0.5rem;
      padding: 0.75rem 1rem;
      background: var(--color-text);
      color: white;
      border-radius: var(--shape-border-radius-3);
      font: var(--type-body-2-default-font);
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      z-index: 1000;
      box-shadow: var(--shape-shadow-3);
    }

    .tooltip-content::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: var(--color-text);
    }

    .tooltip-wrapper:hover .tooltip-content {
      opacity: 1;
    }

    /* Project Tips Styles */
    .project-tips {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--color-border);
    }

    .project-tips-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--color-text);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .project-tips-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .project-tips-list li {
      padding: 0.5rem 0;
      font: var(--type-body-2-default-font);
      color: var(--color-text-secondary);
      padding-left: 1.5rem;
      position: relative;
    }

    .project-tips-list li::before {
      content: '‚Ä¢';
      position: absolute;
      left: 0;
      color: var(--color-brand-500);
      font-weight: 600;
    }

    /* Resource Links Styles */
    .resource-links {
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 1px solid var(--color-border);
    }

    .resource-links-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--color-text);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .resource-links-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .resource-links-list li {
      padding: 0.5rem 0;
    }

    .resource-link {
      color: var(--color-brand-500);
      text-decoration: none;
      font: var(--type-body-2-default-font);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: color 0.2s ease;
    }

    .resource-link:hover {
      color: var(--color-brand-600);
      text-decoration: underline;
    }

    .resource-link::after {
      content: '‚Üí';
      font-size: 0.875rem;
    }

    /* Quote Actions Styles */
    .quote-actions {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 1px solid var(--color-border);
      flex-wrap: wrap;
    }

    .quote-action-btn {
      flex: 1;
      min-width: 120px;
    }

    /* Project Notes Styles */
    .project-notes {
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 1px solid var(--color-border);
    }

    .project-notes-label {
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--color-text);
      display: block;
    }

    .project-notes-textarea {
      width: 100%;
      min-height: 100px;
      padding: 0.75rem;
      border: 1px solid var(--color-border);
      border-radius: var(--shape-border-radius-3);
      font: var(--type-body-1-default-font);
      resize: vertical;
    }

    .project-notes-textarea:focus {
      outline: 2px solid var(--color-brand-500);
      outline-offset: 2px;
      border-color: var(--color-brand-500);
    }

    .project-notes-hint {
      font: var(--type-details-caption-1-font);
      color: var(--color-text-secondary);
      margin-top: 0.5rem;
    }

    /* Print Styles */
    @media print {
      @page {
        margin: 1in;
      }

      /* Hide navigation and interactive elements */
      .wizard-progress,
      .wizard-navigation,
      .header,
      .industry-menu,
      .wizard-sidebar,
      .bundle-actions,
      .category-toggle,
      .quote-actions,
      .project-notes,
      .resource-links,
      .qty-btn,
      .component-toggles {
        display: none !important;
      }

      .wizard-layout {
        grid-template-columns: 1fr;
      }

      .wizard-sidebar {
        position: static;
        page-break-inside: avoid;
      }

      .sidebar-card {
        border: 2px solid var(--color-border);
      }

      .wizard-content {
        page-break-inside: avoid;
      }

      .category-items {
        display: block !important;
      }

      .products-table {
        font-size: 10pt;
      }

      .products-table th,
      .products-table td {
        padding: 0.5rem;
      }

      body {
        font-size: 12pt;
      }

      .bundle-summary {
        page-break-inside: avoid;
      }

      /* Print header */
      .print-header {
        display: block !important;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #000;
      }

      .print-header-logo {
        font-size: 24pt;
        font-weight: 700;
        color: #0f5ba7;
        margin-bottom: 0.5rem;
      }

      .print-header-title {
        font-size: 18pt;
        font-weight: 600;
        margin-bottom: 0.5rem;
      }

      .print-header-details {
        font-size: 10pt;
        color: #666;
        margin-bottom: 0.5rem;
      }

      .print-header-date {
        font-size: 10pt;
        color: #666;
      }

      /* Show project notes in print if available */
      .print-notes {
        display: block !important;
        margin-top: 1rem;
        padding: 1rem;
        background: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 10pt;
      }

      .print-notes-label {
        font-weight: 600;
        margin-bottom: 0.5rem;
      }

      /* Ensure all category items are visible in print */
      .bundle-category-section.excluded {
        opacity: 1 !important;
      }

      .category-items.excluded {
        display: block !important;
      }
    }
  </style>
</head>
<body>
  <!-- Header Block -->
  <div class="header">
    <div class="header-top">
      <div class="header-top-content">
        <div class="header-location">
          <span class="location-label">You're Shopping</span>
          <div class="location-selector-wrapper">
            <button class="location-selector" id="location-selector">
              <span class="location-name">Premium Commercial Builders - Los Angeles, CA</span>
              <span class="location-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg></span>
            </button>
            <!-- Location Dropdown -->
            <div class="location-menu" id="location-menu">
              <div class="location-menu-content">
                <ul class="location-menu-list" id="location-menu-list">
                  <!-- Locations will be populated by JavaScript -->
                </ul>
              </div>
            </div>
          </div>
        </div>
        <div class="header-top-links">
          <a href="pages/order-history.html">Order History</a>
          <a href="pages/account.html#lists">My Lists</a>
          <a href="pages/account.html#help">Help</a>
        </div>
      </div>
    </div>
    <div class="header-main">
      <div class="header-main-content">
        <div class="header-brand">
          <a href="index.html">BuildRight</a>
        </div>
        <div class="header-search">
          <input type="search" placeholder="Search products, SKUs, or keywords..." class="search-input" id="header-search-input">
          <button class="search-button" aria-label="Search">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
              <path d="m21 21-4.34-4.34" />
              <circle cx="11" cy="11" r="8" />
            </svg>
          </button>
        </div>
        <div class="header-actions">
          <a href="pages/login.html" class="header-action-link">
            <span class="action-label">Login</span>
          </a>
          <span class="action-separator">|</span>
          <a href="pages/login.html" class="header-action-link">
            <span class="action-label">Create Account</span>
          </a>
          <a href="pages/cart.html" class="cart-link">
            <span class="cart-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="8" cy="21" r="1"/>
                <circle cx="19" cy="21" r="1"/>
                <path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/>
              </svg>
            </span>
            <span class="cart-label">Cart</span>
            <span class="cart-count">0</span>
          </a>
        </div>
      </div>
    </div>
    <div class="header-nav-bar">
      <div class="header-nav-content">
        <button class="menu-toggle" id="menu-toggle" aria-label="Menu">
          <span></span>
          <span></span>
          <span></span>
        </button>
        <nav class="main-nav">
          <div class="nav-item">
            <a href="catalog" class="nav-link" data-category="all">All Products</a>
          </div>
          <div class="nav-item">
            <a href="pages/project-builder.html" class="nav-link nav-link-cta">Project Builder</a>
          </div>
          <div class="nav-item">
            <button class="nav-link" data-category="structural_materials">Structural Materials</button>
          </div>
          <div class="nav-item">
            <button class="nav-link" data-category="windows_doors">Windows & Doors</button>
          </div>
          <div class="nav-item">
            <button class="nav-link" data-category="fasteners_hardware">Fasteners & Hardware</button>
          </div>
          <div class="nav-item">
            <button class="nav-link" data-category="roofing">Roofing</button>
          </div>
          <div class="nav-item">
            <button class="nav-link" data-category="framing_drywall">Framing & Drywall</button>
          </div>
        </nav>
        <div class="nav-industry">
          <button class="industry-toggle" id="industry-toggle" aria-expanded="false">
            Shop By Industry
            <span class="industry-toggle-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg></span>
          </button>
        </div>
      </div>
    </div>
    <div class="industry-menu" id="industry-menu">
      <div class="industry-menu-content">
        <div class="industry-column">
          <h3>Commercial</h3>
          <ul>
            <li><a href="catalog/commercial">Commercial Construction</a></li>
            <li><a href="catalog/structural-materials">Structural Materials</a></li>
            <li><a href="catalog/windows-doors">Windows & Doors</a></li>
          </ul>
        </div>
        <div class="industry-column">
          <h3>Residential</h3>
          <ul>
            <li><a href="catalog/residential">Residential Construction</a></li>
            <li><a href="catalog/structural-materials">Framing Materials</a></li>
            <li><a href="catalog/windows-doors">Residential Windows</a></li>
          </ul>
        </div>
        <div class="industry-column">
          <h3>Pro</h3>
          <ul>
            <li><a href="catalog/pro">Trade Contractors</a></li>
            <li><a href="catalog/fasteners-hardware">Fasteners & Tools</a></li>
            <li><a href="catalog/roofing">Roofing Supplies</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Breadcrumbs -->
  <div style="background: var(--color-surface); padding: var(--spacing-small) 0; border-bottom: 1px solid var(--color-border);">
    <div class="container">
      <nav style="font: var(--type-body-2-default-font); color: var(--color-text-secondary);">
        <a href="index.html" style="color: var(--color-brand-500); text-decoration: none;">Home</a>
        <span style="margin: 0 var(--spacing-small);">/</span>
        <span>Project Builder</span>
      </nav>
    </div>
  </div>

  <!-- Wizard Container -->
  <div class="wizard-container">
    <h1 style="text-align: center; margin-bottom: 1rem;">Build Your Project</h1>
    <p style="text-align: center; color: var(--color-text-light); margin-bottom: 2rem;">Answer a few questions to get a customized kit of materials for your project</p>

    <!-- Progress Indicator -->
    <div class="wizard-progress">
      <div class="wizard-progress-bar" id="progress-bar"></div>
      <div class="wizard-step" data-step="1">
        <div class="wizard-step-circle">1</div>
        <div class="wizard-step-label">Project Type</div>
      </div>
      <div class="wizard-step" data-step="2">
        <div class="wizard-step-circle">2</div>
        <div class="wizard-step-label">Details</div>
      </div>
      <div class="wizard-step" data-step="3" id="step-indicator-3">
        <div class="wizard-step-circle">3</div>
        <div class="wizard-step-label">Complexity</div>
      </div>
      <div class="wizard-step" data-step="4" id="step-indicator-4">
        <div class="wizard-step-circle">4</div>
        <div class="wizard-step-label">Budget</div>
      </div>
      <div class="wizard-step" data-step="5" id="step-indicator-5">
        <div class="wizard-step-circle">5</div>
        <div class="wizard-step-label">Results</div>
      </div>
    </div>

    <!-- Wizard Layout (Main + Sidebar) -->
    <div class="wizard-layout">
      <!-- Wizard Main Content -->
      <div class="wizard-main">
        <div class="wizard-content">
      <!-- Step 1: Project Type -->
      <div class="wizard-step-content active" data-step="1">
        <h2>
          What type of project are you working on?
          <span class="tooltip-wrapper">
            <span class="tooltip-icon">?</span>
            <span class="tooltip-content">Select the category that best matches your project</span>
          </span>
        </h2>
        <div class="wizard-options-photo">
          <div class="wizard-option-photo" data-value="new_construction" style="background-image: url('https://images.unsplash.com/photo-1541888946425-d81bb19240f5?w=800&q=80')">
            <div class="wizard-photo-overlay">
              <h3>New Construction</h3>
              <p>Building from the ground up</p>
            </div>
          </div>
          <div class="wizard-option-photo" data-value="remodel" style="background-image: url('https://images.unsplash.com/photo-1556912173-46c336c7fd55?w=800&q=80')">
            <div class="wizard-photo-overlay">
              <h3>Remodel</h3>
              <p>Renovating existing space</p>
            </div>
          </div>
          <div class="wizard-option-photo" data-value="repair" style="background-image: url('https://images.unsplash.com/photo-1581244277943-fe4a9c777189?w=800&q=80')">
            <div class="wizard-photo-overlay">
              <h3>Repair</h3>
              <p>Fixing or maintaining</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 2: Project Details (Conditional) -->
      <div class="wizard-step-content" data-step="2">
        <h2 id="step2-title">Tell us more about your project</h2>
        <div class="step-sub-progress" id="step2-sub-progress" style="display: none;">
          <!-- Sub-step dots will be populated dynamically -->
        </div>
        <div class="wizard-options" id="step2-options">
          <!-- Options will be populated by JavaScript based on Step 1 -->
        </div>
      </div>

      <!-- Step 3: Complexity -->
      <div class="wizard-step-content" data-step="3">
        <h2>
          How complex is this project?
          <span class="tooltip-wrapper">
            <span class="tooltip-icon">?</span>
            <span class="tooltip-content">Complexity affects material quality and project timeline</span>
          </span>
        </h2>
        <div class="wizard-options">
          <div class="wizard-option" data-value="basic">
            <svg class="wizard-icon" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="32" cy="32" r="20" stroke="currentColor" stroke-width="2"/>
              <path d="M32 22V32L38 38" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <h3>Basic</h3>
            <p>DIY-friendly, standard materials</p>
          </div>
          <div class="wizard-option" data-value="moderate">
            <svg class="wizard-icon" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="32" cy="32" r="20" stroke="currentColor" stroke-width="2"/>
              <path d="M32 22V32L38 38" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <circle cx="32" cy="12" r="3" fill="currentColor"/>
              <circle cx="32" cy="52" r="3" fill="currentColor"/>
            </svg>
            <h3>Moderate</h3>
            <p>Some professional help, mid-range materials</p>
          </div>
          <div class="wizard-option" data-value="complex">
            <svg class="wizard-icon" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="32" cy="32" r="20" stroke="currentColor" stroke-width="2"/>
              <path d="M32 22V32L38 38" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <circle cx="32" cy="12" r="3" fill="currentColor"/>
              <circle cx="32" cy="52" r="3" fill="currentColor"/>
              <circle cx="12" cy="32" r="3" fill="currentColor"/>
              <circle cx="52" cy="32" r="3" fill="currentColor"/>
            </svg>
            <h3>Complex</h3>
            <p>Professional required, premium materials</p>
          </div>
        </div>
      </div>

      <!-- Step 4: Budget -->
      <div class="wizard-step-content" data-step="4">
        <h2>
          What's your budget range?
          <span class="tooltip-wrapper">
            <span class="tooltip-icon">?</span>
            <span class="tooltip-content">Material costs only. Labor and permits not included.</span>
          </span>
        </h2>
        <div class="wizard-options">
          <div class="wizard-option" data-value="under_5k">
            <svg class="wizard-icon" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="12" y="48" width="8" height="8" fill="currentColor"/>
              <rect x="28" y="40" width="8" height="16" fill="currentColor"/>
              <rect x="44" y="32" width="8" height="24" fill="currentColor" opacity="0.3"/>
            </svg>
            <h3>Under $5,000</h3>
            <p>Small projects</p>
          </div>
          <div class="wizard-option" data-value="5k_15k">
            <svg class="wizard-icon" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="12" y="48" width="8" height="8" fill="currentColor"/>
              <rect x="28" y="40" width="8" height="16" fill="currentColor"/>
              <rect x="44" y="32" width="8" height="24" fill="currentColor"/>
            </svg>
            <h3>$5,000 - $15,000</h3>
            <p>Medium projects</p>
          </div>
          <div class="wizard-option" data-value="15k_30k">
            <svg class="wizard-icon" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="8" y="48" width="8" height="8" fill="currentColor"/>
              <rect x="20" y="40" width="8" height="16" fill="currentColor"/>
              <rect x="32" y="32" width="8" height="24" fill="currentColor"/>
              <rect x="44" y="20" width="8" height="36" fill="currentColor"/>
            </svg>
            <h3>$15,000 - $30,000</h3>
            <p>Large projects</p>
          </div>
        </div>
      </div>

      <!-- Step 5: Results -->
      <div class="wizard-step-content" data-step="5">
        <div class="wizard-results">
          <h2>Your Project Kit is Ready!</h2>
          <p>We've curated a bundle of materials based on your selections.</p>
          <div id="bundle-container">
            <!-- Bundle will be rendered here by JavaScript -->
          </div>
        </div>
      </div>
    </div>

    <!-- Navigation -->
    <div class="wizard-navigation">
      <button class="btn btn-outline" id="wizard-back" style="display: none;">‚Üê Back</button>
      <button class="btn btn-outline" id="wizard-start-over" style="display: none;">Start Over</button>
      <button class="btn btn-outline" id="wizard-print" style="display: none;">üñ® Print Summary</button>
    </div>
      </div>
      <!-- End Wizard Main -->

      <!-- Wizard Sidebar -->
      <div class="wizard-sidebar">
        <div class="sidebar-card">
          <h3 class="sidebar-title">Project Summary</h3>
          <div class="sidebar-content">
            <!-- Selection Progress -->
            <div class="sidebar-selections" id="sidebar-selections">
              <p class="sidebar-empty">Make your selections to see summary</p>
            </div>

            <!-- Estimated Details -->
            <div class="sidebar-estimate" id="sidebar-estimate" style="display: none;">
              <div class="sidebar-divider"></div>
              <div class="sidebar-stat">
                <span class="sidebar-stat-label">Items:</span>
                <span class="sidebar-stat-value" id="sidebar-items">--</span>
              </div>
              <div class="sidebar-stat sidebar-stat-total">
                <span class="sidebar-stat-label">Estimated Total:</span>
                <span class="sidebar-stat-value" id="sidebar-total">$--</span>
              </div>
            </div>

            <!-- Project Tips -->
            <div class="project-tips" id="sidebar-tips" style="display: none;">
              <div class="project-tips-title">üí° Project Tips</div>
              <ul class="project-tips-list" id="project-tips-list"></ul>
            </div>

          </div>
        </div>
      </div>
      <!-- End Wizard Sidebar -->
    </div>
    <!-- End Wizard Layout -->
  </div>


  <script type="module">
    import { saveWizardState, getWizardState, generateBundle, addBundleToCart } from '../scripts/project-builder.js';
    import { decorateBlock } from '../scripts/utils.js';
    import { getProjectTips, getResourceLinks } from '../scripts/educational-content.js';
    import { getProductImageUrl, getInventory, getInventoryStatus, getPrimaryWarehouse } from '../scripts/data-mock.js';

    // Wizard state
    let currentStep = 1;
    const totalSteps = 4;
    let wizardState = getWizardState() || {};

    // Step 2 options based on project type
    const step2Options = {
      new_construction: [
        { value: 'residential_home', label: 'Residential Home', desc: 'Single-family or multi-family home' },
        { value: 'commercial_building', label: 'Commercial Building', desc: 'Office, retail, or commercial space' },
        { value: 'addition', label: 'Addition', desc: 'Adding to existing structure' },
        { value: 'other', label: 'Other', desc: 'Other new construction' }
      ],
      remodel: [
        { value: 'bathroom', label: 'Bathroom', desc: 'Bathroom renovation' },
        { value: 'kitchen', label: 'Kitchen', desc: 'Kitchen renovation' },
        { value: 'basement', label: 'Basement', desc: 'Basement finishing' },
        { value: 'whole_house', label: 'Whole House', desc: 'Complete home remodel' },
        { value: 'exterior', label: 'Exterior', desc: 'Exterior renovation' },
        { value: 'other', label: 'Other', desc: 'Other remodeling' }
      ],
      repair: [
        { value: 'plumbing', label: 'Plumbing', desc: 'Plumbing repairs' },
        { value: 'electrical', label: 'Electrical', desc: 'Electrical repairs' },
        { value: 'structural', label: 'Structural', desc: 'Structural repairs' },
        { value: 'roofing', label: 'Roofing', desc: 'Roof repairs' },
        { value: 'other', label: 'Other', desc: 'Other repairs' }
      ]
    };

    // Initialize wizard
    async function initWizard() {
      // Import URL router for path parsing
      const { parseProjectBuilderPath } = await import('../scripts/url-router.js');
      
      // Check for path-based parameters first (from Shop By Job links)
      const pathInfo = parseProjectBuilderPath(window.location.pathname);
      const projectType = pathInfo.projectType;
      const projectDetail = pathInfo.projectDetail;
      
      // Check URL query params for backward compatibility
      const urlParams = new URLSearchParams(window.location.search);
      const complexity = urlParams.get('complexity');
      const budget = urlParams.get('budget');
      
      if (projectType) {
        // URL params override saved state
        wizardState = {
          projectType: projectType,
          projectDetail: projectDetail || null,
          complexity: complexity || null,
          budget: budget || null,
          currentStep: 1
        };
        saveWizardState(wizardState);
        // Auto-advance through pre-filled steps
        if (projectType) {
          currentStep = 1;
          if (projectDetail) {
            populateStep2(projectType);
            currentStep = 2;
            if (complexity) {
              currentStep = 3;
              if (budget) {
                currentStep = 4;
              }
            }
          }
        }
        restoreWizardState();
        showStep(currentStep);
      } else if (wizardState.projectType) {
        // Load saved state if no URL params
        currentStep = wizardState.currentStep || 1;
        restoreWizardState();
        showStep(currentStep);
      } else {
        // Start fresh
        showStep(1);
      }
      
      updateProgress();
      updateNavigation();
      setupEventListeners();
    }

    // Restore wizard state
    function restoreWizardState() {
      // Restore step 1
      if (wizardState.projectType) {
        const option = document.querySelector(`[data-step="1"] [data-value="${wizardState.projectType}"]`);
        if (option) option.classList.add('selected');
      }

      // Restore step 2
      if (wizardState.projectDetail) {
        populateStep2(wizardState.projectType);
        const option = document.querySelector(`[data-step="2"] [data-value="${wizardState.projectDetail}"]`);
        if (option) option.classList.add('selected');
      }

      // Restore step 3
      if (wizardState.complexity) {
        const option = document.querySelector(`[data-step="3"] .wizard-option[data-value="${wizardState.complexity}"]`);
        if (option) option.classList.add('selected');
      }

      // Restore step 4
      if (wizardState.budget) {
        const option = document.querySelector(`[data-step="4"] .wizard-option[data-value="${wizardState.budget}"]`);
        if (option) option.classList.add('selected');
      }

      // If we have all data, show results
      if (wizardState.projectType && wizardState.complexity && wizardState.budget) {
        if (wizardState.projectType === 'remodel' && !wizardState.projectDetail) {
          currentStep = 2;
        } else {
          currentStep = 5;
          showResults();
        }
      }
    }

    // Setup event listeners
    function setupEventListeners() {
      // Option selection - use event delegation on wizard-content
      const wizardContent = document.querySelector('.wizard-content');
      if (!wizardContent) {
        console.error('Wizard content element not found');
        return;
      }
      
      // Add click listener with event delegation
      wizardContent.addEventListener('click', (e) => {
        const option = e.target.closest('.wizard-option, .wizard-option-photo');
        if (option) {
          const stepContent = option.closest('.wizard-step-content');
          if (stepContent) {
            const step = stepContent.dataset.step;
            const value = option.dataset.value;
            if (step && value) {
              console.log('Option clicked:', step, value);
              selectOption(step, value);
            } else {
              console.warn('Missing step or value:', { step, value, option, stepContent });
            }
          } else {
            console.warn('Could not find step-content parent for option', option);
          }
        }
      });
      
      // Also add direct listeners to options as fallback
      document.querySelectorAll('.wizard-option, .wizard-option-photo').forEach(option => {
        option.addEventListener('click', function(e) {
          e.stopPropagation();
          const stepContent = this.closest('.wizard-step-content');
          if (stepContent) {
            const step = stepContent.dataset.step;
            const value = this.dataset.value;
            if (step && value) {
              console.log('Direct option click:', step, value);
              selectOption(step, value);
            }
          }
        });
      });

      // Navigation buttons
      const backBtn = document.getElementById('wizard-back');
      const startOverBtn = document.getElementById('wizard-start-over');
      
      if (backBtn) backBtn.addEventListener('click', prevStep);
      if (startOverBtn) startOverBtn.addEventListener('click', startOver);

      // Make step circles clickable for navigation
      document.querySelectorAll('.wizard-step').forEach(stepEl => {
        const stepNumber = stepEl.dataset.step;
        if (stepNumber) {
          stepEl.addEventListener('click', () => {
            const stepNum = parseFloat(stepNumber);
            if (stepEl.classList.contains('completed') || stepEl.classList.contains('active')) {
              goToStep(stepNum);
            }
          });
        }
      });
    }

    // Select option
    function selectOption(step, value) {
      // Remove previous selection
      const stepContent = document.querySelector(`[data-step="${step}"]`);
      stepContent.querySelectorAll('.wizard-option, .wizard-option-photo').forEach(opt => opt.classList.remove('selected'));
      
      // Add new selection
      const option = stepContent.querySelector(`[data-value="${value}"]`);
      if (option) option.classList.add('selected');

      // Save to state
      if (step === '1') {
        wizardState.projectType = value;
        wizardState.projectDetail = null; // Reset detail when type changes
      } else if (step === '2') {
        wizardState.projectDetail = value;
      } else if (step === '3') {
        wizardState.complexity = value;
      } else if (step === '4') {
        wizardState.budget = value;
      }

      wizardState.currentStep = parseInt(step);
      saveWizardState(wizardState);
      updateSidebar();

      // Auto-advance logic
      if (step === '1') {
        setTimeout(() => nextStep(), 300);
      } else if (step === '2') {
        setTimeout(() => nextStep(), 300);
      } else if (step === '3') {
        setTimeout(() => nextStep(), 300);
      } else if (step === '4') {
        // Step 4: Generate bundle
        generateAndShowResults();
      }
    }

    // Icons for Step 2 options - using custom SVG icons
    // Photo URLs for Step 2 project types
    const step2Photos = {
      residential_home: 'https://images.unsplash.com/photo-1568605114967-8130f3a36994?w=800&q=80',
      commercial_building: 'https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?w=800&q=80',
      addition: 'https://images.unsplash.com/photo-1503387762-592deb58ef4e?w=800&q=80',
      bathroom: 'https://images.unsplash.com/photo-1552321554-5fefe8c9ef14?w=800&q=80',
      kitchen: 'https://images.unsplash.com/photo-1484154218962-a197022b5858?w=800&q=80',
      basement: 'https://images.unsplash.com/photo-1627257060697-acfbecf5d9a2?w=800&q=80',
      whole_house: 'https://images.unsplash.com/photo-1600585154340-be6161a56a0c?w=800&q=80',
      exterior: 'https://images.unsplash.com/photo-1600607687939-ce8a6c25118c?w=800&q=80',
      plumbing: 'https://images.unsplash.com/photo-1607472586893-edb57bdc0e39?w=800&q=80',
      electrical: 'https://images.unsplash.com/photo-1621905251918-48416bd8575a?w=800&q=80',
      structural: 'https://images.unsplash.com/photo-1504307651254-35680f356dfd?w=800&q=80',
      roofing: 'https://images.unsplash.com/photo-1562259949-e8e7689d7828?w=800&q=80',
      other: 'https://images.unsplash.com/photo-1504328345606-18bbc8c9d7d1?w=800&q=80'
    };

    // Populate step 2 based on project type
    function populateStep2(projectType) {
      const options = step2Options[projectType] || [];
      const container = document.getElementById('step2-options');
      const title = document.getElementById('step2-title');

      if (projectType === 'remodel') {
        title.textContent = 'What are you remodeling?';
      } else if (projectType === 'new_construction') {
        title.textContent = 'What are you building?';
      } else if (projectType === 'repair') {
        title.textContent = 'What needs repair?';
      }

      // Limit to 3 cards
      const limitedOptions = options.slice(0, 3);
      
      // Add class to container for photo-based layout
      container.className = 'wizard-options-photo';
      
      container.innerHTML = limitedOptions.map(opt => `
        <div class="wizard-option-photo" data-value="${opt.value}" style="background-image: url('${step2Photos[opt.value] || step2Photos.other}')">
          <div class="wizard-photo-overlay">
            <h3>${opt.label}</h3>
            <p>${opt.desc}</p>
          </div>
        </div>
      `).join('');

      // Event listeners are handled by delegation in setupEventListeners
    }

    // Update sidebar with current selections
    function updateSidebar() {
      const selectionsContainer = document.getElementById('sidebar-selections');
      const estimateContainer = document.getElementById('sidebar-estimate');
      const itemsElement = document.getElementById('sidebar-items');
      const totalElement = document.getElementById('sidebar-total');

      // Label mappings
      const labels = {
        projectType: {
          new_construction: 'New Construction',
          remodel: 'Remodel',
          repair: 'Repair'
        },
        complexity: {
          basic: 'Basic',
          moderate: 'Moderate',
          complex: 'Complex'
        },
        budget: {
          under_5k: 'Under $5,000',
          '5k_15k': '$5,000 - $15,000',
          '15k_30k': '$15,000 - $30,000'
        }
      };

      // Build selections HTML
      let selectionsHTML = '';
      let hasSelections = false;

      if (wizardState.projectType) {
        hasSelections = true;
        selectionsHTML += `
          <div class="sidebar-selection">
            <div class="sidebar-selection-label">Project Type</div>
            <div class="sidebar-selection-value">${labels.projectType[wizardState.projectType] || wizardState.projectType}</div>
          </div>
        `;
      }

      if (wizardState.projectDetail) {
        const detailOptions = step2Options[wizardState.projectType] || [];
        const detailOption = detailOptions.find(opt => opt.value === wizardState.projectDetail);
        selectionsHTML += `
          <div class="sidebar-selection">
            <div class="sidebar-selection-label">Details</div>
            <div class="sidebar-selection-value">${detailOption ? detailOption.label : wizardState.projectDetail}</div>
          </div>
        `;
      }

      if (wizardState.complexity) {
        selectionsHTML += `
          <div class="sidebar-selection">
            <div class="sidebar-selection-label">Complexity</div>
            <div class="sidebar-selection-value">${labels.complexity[wizardState.complexity] || wizardState.complexity}</div>
          </div>
        `;
      }

      if (wizardState.budget) {
        selectionsHTML += `
          <div class="sidebar-selection">
            <div class="sidebar-selection-label">Budget Range</div>
            <div class="sidebar-selection-value">${labels.budget[wizardState.budget] || wizardState.budget}</div>
          </div>
        `;
      }

      // Update selections
      if (hasSelections) {
        selectionsContainer.innerHTML = selectionsHTML;
      } else {
        selectionsContainer.innerHTML = '<p class="sidebar-empty">Make your selections to see summary</p>';
      }

      // Show estimate if we have enough data
      if (wizardState.complexity && wizardState.budget) {
        estimateContainer.style.display = 'flex';
        
        // Simple estimation logic
        const budgetMultipliers = {
          under_5k: 0.5,
          '5k_15k': 1.0,
          '15k_30k': 1.8
        };
        
        const complexityMultipliers = {
          basic: 0.6,
          moderate: 1.0,
          complex: 1.5
        };
        
        const baseItems = 12;
        const basePrice = 5000;
        
        const budgetMult = budgetMultipliers[wizardState.budget] || 1.0;
        const complexMult = complexityMultipliers[wizardState.complexity] || 1.0;
        
        const estimatedItems = Math.round(baseItems * budgetMult * complexMult);
        const estimatedTotal = Math.round(basePrice * budgetMult * complexMult);
        
        itemsElement.textContent = estimatedItems;
        totalElement.textContent = `$${estimatedTotal.toLocaleString()}`;
      } else {
        estimateContainer.style.display = 'none';
      }

      // Update project tips
      const tipsContainer = document.getElementById('sidebar-tips');
      const tipsList = document.getElementById('project-tips-list');
      if (wizardState.projectType && wizardState.projectDetail && wizardState.complexity) {
        const tips = getProjectTips(wizardState.projectType, wizardState.projectDetail, wizardState.complexity);
        if (tips && tips.length > 0) {
          tipsList.innerHTML = tips.map(tip => `<li>${tip}</li>`).join('');
          tipsContainer.style.display = 'block';
        } else {
          tipsContainer.style.display = 'none';
        }
      } else {
        tipsContainer.style.display = 'none';
      }
      
    }

    // Go to step (for clickable navigation)
    function goToStep(stepNum) {
      // Only allow navigation to completed or active steps
      const stepEl = document.querySelector(`.wizard-step[data-step="${stepNum}"]`);
      if (!stepEl) return;
      
      // Check if step is completed or active
      if (!stepEl.classList.contains('completed') && !stepEl.classList.contains('active')) {
        return; // Don't allow navigation to future steps
      }
      
      // Map display step numbers to actual step numbers
      if (stepNum === 1) {
        showStep(1);
      } else if (stepNum === 2) {
        showStep(2);
      } else if (stepNum === 3) {
        showStep(3);
      } else if (stepNum === 4) {
        showStep(4);
      } else if (stepNum === 5) {
        showStep(5);
      }
    }

    // Show step
    function showStep(step) {
      currentStep = step;
      
      // Hide all steps
      document.querySelectorAll('.wizard-step-content').forEach(content => {
        content.classList.remove('active');
        content.style.display = 'none';
      });

      // Show current step
      const currentContent = document.querySelector(`.wizard-step-content[data-step="${step}"]`);
      if (currentContent) {
        currentContent.classList.add('active');
        currentContent.style.display = 'block';
      }

      // Update progress indicators
      const stepNum = typeof step === 'number' ? step : parseFloat(step);
      
      document.querySelectorAll('.wizard-step').forEach((stepEl, index) => {
        const stepIndex = index + 1;
        stepEl.classList.remove('active', 'completed', 'future');
        
        // Update step labels dynamically
        const stepCircle = stepEl.querySelector('.wizard-step-circle');
        const stepLabel = stepEl.querySelector('.wizard-step-label');
        
        // Hide step 6 indicator (no longer needed)
        const step6Indicator = document.getElementById('step-indicator-6');
        if (step6Indicator) {
          step6Indicator.style.display = 'none';
        }
        
        // Step numbering: 1, 2, 3(Complexity), 4(Budget), 5(Results)
        if (stepIndex === 1) {
          if (stepCircle) stepCircle.textContent = '1';
          if (stepLabel) stepLabel.textContent = 'Project Type';
          stepEl.style.display = 'flex';
        } else if (stepIndex === 2) {
          if (stepCircle) stepCircle.textContent = '2';
          if (stepLabel) stepLabel.textContent = 'Details';
          stepEl.style.display = 'flex';
        } else if (stepIndex === 3) {
          if (stepCircle) stepCircle.textContent = '3';
          if (stepLabel) stepLabel.textContent = 'Complexity';
          stepEl.style.display = 'flex';
        } else if (stepIndex === 4) {
          if (stepCircle) stepCircle.textContent = '4';
          if (stepLabel) stepLabel.textContent = 'Budget';
          stepEl.style.display = 'flex';
        } else if (stepIndex === 5) {
          if (stepCircle) stepCircle.textContent = '5';
          if (stepLabel) stepLabel.textContent = 'Results';
          stepEl.style.display = 'flex';
        } else if (stepIndex === 6) {
          stepEl.style.display = 'none';
        }
        
        // Set active/completed/future states
        if (stepIndex < stepNum) {
          stepEl.classList.add('completed');
        } else if (stepIndex === stepNum) {
          stepEl.classList.add('active');
        } else {
          stepEl.classList.add('future');
        }
      });

      // Update progress bar - align with step circle centers
      const progressSteps = totalSteps;
      const progressStep = stepNum;
      
      const progressBar = document.getElementById('progress-bar');
      if (progressBar) {
        // Use requestAnimationFrame to ensure layout is complete
        requestAnimationFrame(() => {
          const container = progressBar.parentElement;
          if (container) {
            // Get all visible step circles
            const stepElements = Array.from(container.querySelectorAll('.wizard-step')).filter(step => {
              const style = window.getComputedStyle(step);
              return style.display !== 'none' && step.style.display !== 'none';
            });
            
            if (stepElements.length > 0) {
              // Get the first and last step circle center positions
              const firstStep = stepElements[0];
              const lastStep = stepElements[stepElements.length - 1];
              const firstCircle = firstStep.querySelector('.wizard-step-circle');
              const lastCircle = lastStep.querySelector('.wizard-step-circle');
              
              // Calculate which step index we're on (1-based)
              const currentStepIndex = Math.min(progressStep, stepElements.length);
              const targetStep = stepElements[currentStepIndex - 1];
              const targetCircle = targetStep ? targetStep.querySelector('.wizard-step-circle') : null;
              
              if (firstCircle && lastCircle && targetCircle) {
                // Get positions relative to container
                const containerRect = container.getBoundingClientRect();
                const firstCircleRect = firstCircle.getBoundingClientRect();
                const lastCircleRect = lastCircle.getBoundingClientRect();
                const targetCircleRect = targetCircle.getBoundingClientRect();
                
                // Calculate center positions relative to container
                const firstCenter = firstCircleRect.left - containerRect.left + (firstCircleRect.width / 2);
                const lastCenter = lastCircleRect.left - containerRect.left + (lastCircleRect.width / 2);
                const targetCenter = targetCircleRect.left - containerRect.left + (targetCircleRect.width / 2);
                
                // Update background line to span from first to last circle center
                const backgroundLine = container.querySelector('.wizard-progress::before');
                if (container.style) {
                  // Set CSS custom properties for the background line
                  container.style.setProperty('--line-start', `${firstCenter}px`);
                  container.style.setProperty('--line-end', `${lastCenter}px`);
                }
                
                // Set progress bar to start at first circle center and extend to target circle center
                progressBar.style.left = `${firstCenter}px`;
                progressBar.style.width = `${Math.max(0, targetCenter - firstCenter)}px`;
                
                // Enable transitions after initial positioning
                requestAnimationFrame(() => {
                  progressBar.classList.add('initialized');
                });
              }
            } else {
              // Fallback: use percentage calculation
              const progress = ((progressStep - 1) / (progressSteps - 1)) * 100;
              const containerWidth = container.offsetWidth;
              const paddingLeft = parseFloat(getComputedStyle(container).paddingLeft);
              const paddingRight = parseFloat(getComputedStyle(container).paddingRight);
              const availableWidth = containerWidth - paddingLeft - paddingRight;
              const progressWidth = (availableWidth * progress) / 100;
              progressBar.style.left = `${paddingLeft}px`;
              progressBar.style.width = `${progressWidth}px`;
              
              // Enable transitions after initial positioning
              requestAnimationFrame(() => {
                progressBar.classList.add('initialized');
              });
            }
          }
        });
      }

      // Handle step 2 population
      if (step === 2 && wizardState.projectType) {
        populateStep2(wizardState.projectType);
      }

      updateNavigation();
    }

    // Next step
    function nextStep() {
      // Validate current step
      if (currentStep === 1 && !wizardState.projectType) return;
      if (currentStep === 2 && !wizardState.projectDetail) return;
      if (currentStep === 3 && !wizardState.complexity) return;
      if (currentStep === 4 && !wizardState.budget) return;

      // Advance to next step
      if (currentStep === 1) {
        showStep(2);
      } else if (currentStep === 2) {
        showStep(3);
      } else if (currentStep === 3) {
        showStep(4);
      } else if (currentStep === 4) {
        generateAndShowResults();
      }
    }

    // Previous step
    function prevStep() {
      if (currentStep > 1) {
        showStep(currentStep - 1);
      }
    }


    // Update progress
    function updateProgress() {
      showStep(currentStep);
    }

    // Update navigation
    function updateNavigation() {
      const backBtn = document.getElementById('wizard-back');
      const startOverBtn = document.getElementById('wizard-start-over');
      const printBtn = document.getElementById('wizard-print');

      if (currentStep === 5) {
        backBtn.style.display = 'none';
        startOverBtn.style.display = 'inline-block';
        if (printBtn) printBtn.style.display = 'inline-block';
      } else {
        backBtn.style.display = currentStep > 1 ? 'inline-block' : 'none';
        startOverBtn.style.display = 'none';
        if (printBtn) printBtn.style.display = 'none';
      }
    }

    // Generate and show results
    async function generateAndShowResults() {
      showStep(5);
      
      // Show loading state
      const container = document.getElementById('bundle-container');
      container.innerHTML = `
        <div style="text-align: center; padding: 3rem;">
          <div style="font-size: 2rem; margin-bottom: 1rem;">‚è≥</div>
          <p>Generating your project kit...</p>
        </div>
      `;
      
      try {
        const bundle = await generateBundle(wizardState);
        if (bundle) {
          displayBundle(bundle);
          showToast('success', 'Project kit generated successfully!', 'Your customized bundle is ready.');
        } else {
          throw new Error('Failed to generate bundle');
        }
      } catch (error) {
        console.error('Error generating bundle:', error);
        container.innerHTML = `
          <div class="error-message">
            <span class="error-message-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3" />
                <path d="M12 9v4" />
                <path d="M12 17h.01" />
              </svg>
            </span>
            <div>
              <div style="font-weight: 600; margin-bottom: 0.25rem;">Unable to generate bundle</div>
              <div style="font-size: 0.875rem;">${error.message || 'Please check your selections and try again.'}</div>
            </div>
          </div>
          <div style="text-align: center; margin-top: 1.5rem;">
            <button class="btn btn-primary" onclick="prevStep()">‚Üê Go Back</button>
          </div>
        `;
        showToast('error', 'Generation Failed', 'Unable to create your project kit. Please try again.');
      }
    }

    // Show results (if already generated)
    async function showResults() {
      if (wizardState.bundle) {
        displayBundle(wizardState.bundle);
      } else {
        await generateAndShowResults();
      }
    }

    // Display bundle
    function displayBundle(bundle) {
      const container = document.getElementById('bundle-container');
      
      // Group items by category
      const itemsByCategory = {};
      bundle.items.forEach(item => {
        const category = item.category || 'Other';
        if (!itemsByCategory[category]) {
          itemsByCategory[category] = [];
        }
        itemsByCategory[category].push(item);
      });

      // Format category name
      function formatCategoryName(cat) {
        return cat.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
      }

      // Category mapping for component toggles
      const categoryMapping = {
        'structural_materials': 'Primary Materials',
        'framing_drywall': 'Primary Materials',
        'windows_doors': 'Primary Materials',
        'fasteners_hardware': 'Fasteners & Hardware',
        'roofing': 'Finishing Materials'
      };

      // Group categories into component groups
      const componentGroups = {
        'Primary Materials': ['structural_materials', 'framing_drywall', 'windows_doors'],
        'Fasteners & Hardware': ['fasteners_hardware'],
        'Tools & Accessories': [], // Empty for now
        'Finishing Materials': ['roofing']
      };

      // Calculate prices per component group
      const componentPrices = {};
      Object.keys(componentGroups).forEach(group => {
        componentPrices[group] = 0;
        componentGroups[group].forEach(cat => {
          if (itemsByCategory[cat]) {
            itemsByCategory[cat].forEach(item => {
              componentPrices[group] += item.subtotal;
            });
          }
        });
      });

      // Default included groups (Primary Materials + Fasteners ON, others OFF)
      const includedGroups = new Set(['Primary Materials', 'Fasteners & Hardware']);

      // Build print header
      const labels = {
        projectType: {
          new_construction: 'New Construction',
          remodel: 'Remodel',
          repair: 'Repair'
        },
        complexity: {
          basic: 'Basic',
          moderate: 'Moderate',
          complex: 'Complex'
        }
      };

      const projectTypeLabel = labels.projectType[wizardState.projectType] || wizardState.projectType;
      const detailOptions = step2Options[wizardState.projectType] || [];
      const detailOption = detailOptions.find(opt => opt.value === wizardState.projectDetail);
      const projectDetailLabel = detailOption ? detailOption.label : wizardState.projectDetail;
      const complexityLabel = labels.complexity[wizardState.complexity] || wizardState.complexity;
      const generatedDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
      
      const printHeaderHTML = `
        <div class="print-header" style="display: none;">
          <div class="print-header-logo">BuildRight Solutions</div>
          <div class="print-header-title">Project Materials Quote</div>
          <div class="print-header-details">
            Project: ${projectDetailLabel} ${projectTypeLabel} (${complexityLabel})
          </div>
          <div class="print-header-date">Generated on ${generatedDate}</div>
        </div>
      `;

      // Build print notes if available
      const notes = sessionStorage.getItem('buildright_project_notes');
      const printNotesHTML = notes && notes.trim() ? `
        <div class="print-notes" style="display: none;">
          <div class="print-notes-label">Project Notes:</div>
          <div>${notes.replace(/\n/g, '<br>')}</div>
        </div>
      ` : '';

      container.innerHTML = `
        <div class="project-bundle" data-bundle-id="${bundle.bundleId}">
          ${printHeaderHTML}
          ${printNotesHTML}
          <div class="bundle-header">
            <div class="bundle-badge">PROJECT KIT</div>
            <h3 class="bundle-title">${bundle.bundleName}</h3>
            <p class="bundle-subtitle">${bundle.itemCount} items included</p>
          </div>
          
          <div class="bundle-summary">
            <div class="bundle-total">
              <div class="bundle-total-label">Total Price</div>
              <div class="bundle-total-value" id="bundle-total-value">$${bundle.totalPrice.toFixed(2)}</div>
            </div>
            <button class="btn btn-cta btn-lg" id="add-bundle-btn">Add Kit to Cart</button>
          </div>
          
          <!-- Component Toggles -->
          <div class="component-toggles">
            <h4 class="component-toggles-title">Customize Your Kit</h4>
            ${Object.keys(componentGroups).map(group => {
              const isIncluded = includedGroups.has(group);
              const price = componentPrices[group];
              if (price === 0 && group !== 'Tools & Accessories') return ''; // Skip empty groups
              return `
                <div class="component-toggle-item">
                  <label class="component-toggle-label">
                    <input type="checkbox" class="component-toggle-checkbox" data-group="${group}" ${isIncluded ? 'checked' : ''}>
                    <span>${group}</span>
                  </label>
                  <span class="component-toggle-price">$${price.toFixed(2)}</span>
                </div>
              `;
            }).join('')}
            <div class="component-toggle-item">
              <span class="component-toggle-label">Total:</span>
              <span class="component-toggle-price" id="component-total-price">$${bundle.totalPrice.toFixed(2)}</span>
            </div>
          </div>
          
          <div class="bundle-products">
            <h4 class="bundle-products-title">Kit Contents</h4>
            ${Object.keys(itemsByCategory).map(category => {
              const groupName = categoryMapping[category] || 'Other';
              const isIncluded = includedGroups.has(groupName);
              return `
              <div class="bundle-category-section ${isIncluded ? '' : 'excluded'}" data-category="${category}" data-group="${groupName}">
                <div class="category-toggle ${isIncluded ? '' : 'excluded'}">
                  <span class="category-name">${formatCategoryName(category)}</span>
                  <span class="category-count">${itemsByCategory[category].length} items</span>
                  <span class="category-price">$${itemsByCategory[category].reduce((sum, item) => sum + item.subtotal, 0).toFixed(2)}</span>
                </div>
                <div class="category-items ${isIncluded ? '' : 'excluded'}" id="category-${category}" style="display: ${isIncluded ? 'block' : 'none'};">
                  <table class="products-table">
                    <thead>
                      <tr>
                        <th>Image</th>
                        <th>Product</th>
                        <th>SKU</th>
                        <th>Stock</th>
                        <th>Qty</th>
                        <th>Unit Price</th>
                        <th>Subtotal</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${itemsByCategory[category].map(item => {
                        const imageUrl = getProductImageUrl(item.sku);
                        const inventoryStatus = getInventoryStatus({ sku: item.sku }, getPrimaryWarehouse());
                        const stockStatus = inventoryStatus === 'in_stock' ? '‚úì In Stock' : 
                                          inventoryStatus === 'low_stock' ? '‚ö† Low Stock' : '‚úó Out of Stock';
                        const stockClass = inventoryStatus === 'in_stock' ? 'stock-in' : 
                                         inventoryStatus === 'low_stock' ? 'stock-low' : 'stock-out';
                        return `
                        <tr>
                          <td>
                            <img src="${imageUrl}" alt="${item.name}" class="product-thumbnail" onerror="this.style.display='none'">
                          </td>
                          <td>
                            <div class="product-info">
                              <div class="product-name">${item.name}</div>
                              <div class="product-reason">
                                ${item.reason}
                                <span class="why-item-tooltip" title="${item.reason}">(?)</span>
                              </div>
                            </div>
                          </td>
                          <td class="product-sku">${item.sku}</td>
                          <td>
                            <span class="stock-status ${stockClass}">${stockStatus}</span>
                          </td>
                          <td>
                            <div class="quantity-controls">
                              <button class="qty-btn" data-sku="${item.sku}" data-action="decrease">-</button>
                              <span class="qty-value">${item.quantity}</span>
                              <button class="qty-btn" data-sku="${item.sku}" data-action="increase">+</button>
                            </div>
                          </td>
                          <td class="product-unit-price">$${((item.unitPrice || item.subtotal / item.quantity)).toFixed(2)}</td>
                          <td class="product-subtotal">$${item.subtotal.toFixed(2)}</td>
                        </tr>
                      `;
                      }).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
            `;
            }).join('')}
          </div>
          
          <div class="bundle-actions">
            <a href="catalog" class="btn btn-outline-accent">Customize Kit in Catalog</a>
          </div>

          <!-- Resource Links -->
          <div class="resource-links" id="resource-links-section"></div>

          <!-- Quote Actions -->
          <div class="quote-actions">
            <button class="btn btn-outline quote-action-btn" id="copy-materials-btn">üìã Copy Materials List</button>
            <button class="btn btn-outline quote-action-btn" id="email-quote-btn">‚úâÔ∏è Email Quote</button>
          </div>

          <!-- Project Notes -->
          <div class="project-notes">
            <label for="project-notes-textarea" class="project-notes-label">Project Notes (Optional)</label>
            <textarea id="project-notes-textarea" class="project-notes-textarea" placeholder="Add contractor notes, special instructions, or reminders..."></textarea>
            <div class="project-notes-hint">Notes are saved locally and included in printed quotes</div>
          </div>
        </div>
      `;

      // Add bundle to cart button
      document.getElementById('add-bundle-btn').addEventListener('click', () => {
        // Save order to history before adding to cart
        saveOrderToHistory(bundle);
        addBundleToCart(bundle);
        window.location.href = 'pages/cart.html';
      });

      // Component toggle functionality (include/exclude categories)
      const componentCheckboxes = document.querySelectorAll('.component-toggle-checkbox');
      componentCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          const group = checkbox.dataset.group;
          const isChecked = checkbox.checked;
          
          // Update included groups
          if (isChecked) {
            includedGroups.add(group);
          } else {
            includedGroups.delete(group);
          }
          
          // Update UI and recalculate total
          updateComponentToggles();
        });
      });

      // Function to update component toggles and recalculate total
      function updateComponentToggles() {
        let newTotal = 0;
        
        // Update category sections visibility
        document.querySelectorAll('.bundle-category-section').forEach(section => {
          const group = section.dataset.group;
          const isIncluded = includedGroups.has(group);
          
          if (isIncluded) {
            section.classList.remove('excluded');
            const itemsContainer = section.querySelector('.category-items');
            if (itemsContainer) itemsContainer.style.display = 'block';
            const toggle = section.querySelector('.category-toggle');
            if (toggle) toggle.classList.remove('excluded');
          } else {
            section.classList.add('excluded');
            const itemsContainer = section.querySelector('.category-items');
            if (itemsContainer) itemsContainer.style.display = 'none';
            const toggle = section.querySelector('.category-toggle');
            if (toggle) toggle.classList.add('excluded');
          }
          
          // Calculate total from included items
          if (isIncluded) {
            const category = section.dataset.category;
            if (itemsByCategory[category]) {
              itemsByCategory[category].forEach(item => {
                newTotal += item.subtotal;
              });
            }
          }
        });
        
        // Update total displays
        document.getElementById('bundle-total-value').textContent = `$${newTotal.toFixed(2)}`;
        document.getElementById('component-total-price').textContent = `$${newTotal.toFixed(2)}`;
        
        // Update bundle total in state
        bundle.totalPrice = newTotal;
        wizardState.bundle = bundle;
        saveWizardState(wizardState);
      }

      // Quantity controls
      document.querySelectorAll('.qty-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const sku = btn.dataset.sku;
          const action = btn.dataset.action;
          const qtyElement = btn.parentElement.querySelector('.qty-value');
          let qty = parseInt(qtyElement.textContent);
          
          if (action === 'increase') {
            qty++;
          } else if (action === 'decrease' && qty > 1) {
            qty--;
          }
          
          qtyElement.textContent = qty;
          
          // Update bundle item quantity
          const item = bundle.items.find(i => i.sku === sku);
          if (item) {
            const unitPrice = item.unitPrice || (item.subtotal / item.quantity);
            item.quantity = qty;
            item.subtotal = unitPrice * qty;
            
            // Update subtotal display
            const row = btn.closest('tr');
            const subtotalCell = row.querySelector('.product-subtotal');
            subtotalCell.textContent = `$${item.subtotal.toFixed(2)}`;
            
            // Recalculate bundle total
            bundle.totalPrice = bundle.items.reduce((sum, i) => sum + i.subtotal, 0);
            document.querySelector('.bundle-total-value').textContent = `$${bundle.totalPrice.toFixed(2)}`;
            
            // Update bundle in state
            wizardState.bundle = bundle;
            saveWizardState(wizardState);
          }
        });
      });

      // Show print button
      const printBtn = document.getElementById('wizard-print');
      if (printBtn) {
        printBtn.style.display = 'inline-block';
        printBtn.addEventListener('click', () => {
          window.print();
        });
      }

      // Populate resource links
      const resourceLinksSection = document.getElementById('resource-links-section');
      if (resourceLinksSection && wizardState.projectType && wizardState.projectDetail) {
        const links = getResourceLinks(wizardState.projectType, wizardState.projectDetail);
        if (links && links.length > 0) {
          resourceLinksSection.innerHTML = `
            <div class="resource-links-title">üìö Related Resources</div>
            <ul class="resource-links-list">
              ${links.map(link => `<li><a href="${link.url}" class="resource-link">${link.text}</a></li>`).join('')}
            </ul>
          `;
        }
      }

      // Copy materials list button
      const copyBtn = document.getElementById('copy-materials-btn');
      if (copyBtn) {
        copyBtn.addEventListener('click', () => {
          copyMaterialsList(bundle, wizardState);
        });
      }

      // Email quote button
      const emailBtn = document.getElementById('email-quote-btn');
      if (emailBtn) {
        emailBtn.addEventListener('click', () => {
          emailQuote(bundle, wizardState);
        });
      }

      // Project notes handling
      const notesTextarea = document.getElementById('project-notes-textarea');
      if (notesTextarea) {
        // Load saved notes
        const savedNotes = sessionStorage.getItem('buildright_project_notes');
        if (savedNotes) {
          notesTextarea.value = savedNotes;
        }

        // Save notes on input
        notesTextarea.addEventListener('input', () => {
          sessionStorage.setItem('buildright_project_notes', notesTextarea.value);
        });
      }

      // Save bundle to state
      wizardState.bundle = bundle;
      saveWizardState(wizardState);
      updateSidebar();
    }

    // Save order to history
    function saveOrderToHistory(bundle) {
      try {
        const orders = JSON.parse(localStorage.getItem('buildright_orders') || '[]');
        const order = {
          orderID: 'ORD-' + Date.now(),
          timestamp: new Date().toISOString(),
          wizardState: { ...wizardState },
          products: bundle.items.map(item => ({
            sku: item.sku,
            name: item.name,
            quantity: item.quantity,
            unitPrice: item.subtotal / item.quantity,
            subtotal: item.subtotal
          })),
          total: bundle.totalPrice,
          itemCount: bundle.itemCount,
          status: 'Completed'
        };
        orders.unshift(order); // Add to beginning
        localStorage.setItem('buildright_orders', JSON.stringify(orders));
        
        // Update loyalty spend
        updateLoyaltySpend(bundle.totalPrice);
      } catch (e) {
        console.error('Error saving order:', e);
      }
    }

    // Update loyalty spend
    function updateLoyaltySpend(amount) {
      try {
        const loyaltyData = JSON.parse(localStorage.getItem('buildright_loyalty') || '{"totalSpend": 0}');
        loyaltyData.totalSpend = (loyaltyData.totalSpend || 0) + amount;
        localStorage.setItem('buildright_loyalty', JSON.stringify(loyaltyData));
      } catch (e) {
        console.error('Error updating loyalty:', e);
      }
    }

    // Format materials list for copy/email
    function formatMaterialsList(bundle, wizardState) {
      const labels = {
        projectType: {
          new_construction: 'New Construction',
          remodel: 'Remodel',
          repair: 'Repair'
        },
        complexity: {
          basic: 'Basic',
          moderate: 'Moderate',
          complex: 'Complex'
        }
      };

      const projectTypeLabel = labels.projectType[wizardState.projectType] || wizardState.projectType;
      const detailOptions = step2Options[wizardState.projectType] || [];
      const detailOption = detailOptions.find(opt => opt.value === wizardState.projectDetail);
      const projectDetailLabel = detailOption ? detailOption.label : wizardState.projectDetail;
      const complexityLabel = labels.complexity[wizardState.complexity] || wizardState.complexity;
      
      const projectName = `${projectDetailLabel} ${projectTypeLabel} (${complexityLabel})`;
      const generatedDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
      
      // Group items by category
      const categoryMapping = {
        'Lumber & Framing': 'Primary Materials',
        'Drywall & Panels': 'Primary Materials',
        'Windows & Doors': 'Primary Materials',
        'Fasteners & Hardware': 'Fasteners & Hardware',
        'Tools & Accessories': 'Tools & Accessories',
        'Finishing Materials': 'Finishing Materials',
        'Insulation': 'Finishing Materials',
        'Paint & Coatings': 'Finishing Materials'
      };

      const itemsByGroup = {};
      bundle.items.forEach(item => {
        const group = categoryMapping[item.category] || 'Other';
        if (!itemsByGroup[group]) {
          itemsByGroup[group] = [];
        }
        itemsByGroup[group].push(item);
      });

      let text = `BUILDRIGHT MATERIALS LIST\n`;
      text += `Project: ${projectName}\n`;
      text += `Generated: ${generatedDate}\n\n`;

      // Add project notes if available
      const notes = sessionStorage.getItem('buildright_project_notes');
      if (notes && notes.trim()) {
        text += `NOTES:\n${notes}\n\n`;
      }

      // Add items by group
      Object.keys(itemsByGroup).forEach(group => {
        text += `${group.toUpperCase()}\n`;
        itemsByGroup[group].forEach(item => {
          const unitPrice = item.unitPrice || (item.subtotal / item.quantity);
          text += `- ${item.name} (${item.sku}) x${item.quantity} @ $${unitPrice.toFixed(2)} = $${item.subtotal.toFixed(2)}\n`;
        });
        text += `\n`;
      });

      text += `TOTAL: $${bundle.totalPrice.toFixed(2)}\n`;
      
      return text;
    }

    // Copy materials list to clipboard
    async function copyMaterialsList(bundle, wizardState) {
      try {
        const text = formatMaterialsList(bundle, wizardState);
        await navigator.clipboard.writeText(text);
        showToast('success', 'Copied!', 'Materials list copied to clipboard');
      } catch (err) {
        // Fallback for older browsers
        const textarea = document.createElement('textarea');
        textarea.value = formatMaterialsList(bundle, wizardState);
        document.body.appendChild(textarea);
        textarea.select();
        try {
          document.execCommand('copy');
          showToast('success', 'Copied!', 'Materials list copied to clipboard');
        } catch (e) {
          showToast('error', 'Error', 'Failed to copy materials list');
        }
        document.body.removeChild(textarea);
      }
    }

    // Email quote
    function emailQuote(bundle, wizardState) {
      const labels = {
        projectType: {
          new_construction: 'New Construction',
          remodel: 'Remodel',
          repair: 'Repair'
        },
        complexity: {
          basic: 'Basic',
          moderate: 'Moderate',
          complex: 'Complex'
        }
      };

      const projectTypeLabel = labels.projectType[wizardState.projectType] || wizardState.projectType;
      const detailOptions = step2Options[wizardState.projectType] || [];
      const detailOption = detailOptions.find(opt => opt.value === wizardState.projectDetail);
      const projectDetailLabel = detailOption ? detailOption.label : wizardState.projectDetail;
      
      const subject = encodeURIComponent(`BuildRight Quote - ${projectDetailLabel} ${projectTypeLabel}`);
      const body = encodeURIComponent(formatMaterialsList(bundle, wizardState));
      
      window.location.href = `mailto:?subject=${subject}&body=${body}`;
    }

    // Start over
    function startOver() {
      saveWizardState({});
      window.location.reload();
    }

    // Show toast notification (kept for error handling)
    function showToast(type, title, message) {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      const icons = {
        success: '‚úÖ',
        error: '‚ùå',
        info: '‚ÑπÔ∏è'
      };
      
      toast.innerHTML = `
        <span class="toast-icon">${icons[type] || icons.info}</span>
        <div class="toast-content">
          <div class="toast-title">${title}</div>
          <div class="toast-message">${message}</div>
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
      `;
      
      document.body.appendChild(toast);
      
      // Auto-remove after 5 seconds
      setTimeout(() => {
        if (toast.parentElement) {
          toast.style.animation = 'slideIn 0.3s ease reverse';
          setTimeout(() => toast.remove(), 300);
        }
      }, 5000);
    }

    // Recalculate progress bar on window resize
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        if (currentStep) {
          updateProgress();
        }
      }, 150);
    });

    // Initialize on load - ensure DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initWizard);
    } else {
      // DOM is already loaded
      initWizard();
    }
  </script>
  <script type="module" src="scripts/app.js"></script>
  <script type="module" src="blocks/header/header.js"></script>
</body>
</html>

