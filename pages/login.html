<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Critical initialization: BASE_PATH, cart preload, variant detection -->
  <script src="../scripts/critical-init.js"></script>
  <title>Login - BuildRight Solutions</title>
  <script src="../scripts/scripts.js" type="module"></script>
  <link rel="stylesheet" href="../styles/styles.css">
  <style>
    .login-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      align-items: stretch; /* Make both columns equal height */
    }
    
    .login-grid > div {
      display: flex;
      flex-direction: column;
    }
    
    .login-grid .card {
      flex: 1; /* Card stretches to fill container */
      display: flex;
      flex-direction: column;
    }
    
    .login-grid .card-body {
      flex: 1; /* Card body expands to fill available space */
      display: flex;
      flex-direction: column;
    }
    
    @media (max-width: 768px) {
      .login-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Header loaded dynamically from blocks/header/ -->
  <header></header>

  <!-- Main Content -->
  <main>
    <section class="section">
      <div class="container" style="max-width: 1200px;">
        
        <div style="text-align: center; margin-bottom: 3rem;">
          <h1>Login</h1>
          <p style="color: var(--color-text-light);">Access your personalized catalog and pricing</p>
        </div>

        <div class="login-grid">
        
        <!-- Traditional Login Form -->
        <div>
        <div class="card">
          <div class="card-header" style="text-align: center; border-bottom: 1px solid var(--color-border);">
            <h2 style="margin: 0; font-size: 1.25rem; font-weight: 600;">Email Login</h2>
          </div>
          <div class="card-body">
            <form id="login-form">
              <div class="form-group">
                <label for="email" class="form-label">Email Address</label>
                <input type="email" id="email" class="form-input" required placeholder="your.email@company.com">
              </div>

              <div class="form-group">
                <label for="password" class="form-label">Password</label>
                <input type="password" id="password" class="form-input" required placeholder="Enter your password">
              </div>

              <div class="form-group" style="display: flex; align-items: center; gap: 0.5rem;">
                <input type="checkbox" id="remember" style="width: auto;">
                <label for="remember" style="margin: 0; font-weight: normal;">Remember me</label>
              </div>

              <div class="form-group">
                <button type="submit" class="btn btn-cta btn-lg" style="width: 100%;">Login</button>
              </div>
            </form>
          </div>
          <div class="card-footer" style="text-align: center;">
            <p style="color: var(--color-text-light); margin: 0;">
              Don't have an account? <a href="/pages/signup.html">Create an account</a>
            </p>
          </div>
        </div>
        </div>

        <!-- Quick Persona Login (Demo) -->
        <div>
          <div class="card">
            <div class="card-header" style="text-align: center; border-bottom: 1px solid var(--color-border);">
              <h2 style="margin: 0; font-size: 1.25rem; font-weight: 600;">Quick Login (Demo)</h2>
            </div>
            <div class="card-body">
              <div class="form-group">
                <label for="persona-select" class="form-label" style="font-weight: 600;">Choose a Persona</label>
                <select id="persona-select" class="form-input" style="cursor: pointer; font-size: 1rem;">
                  <option value="">-- Select a persona --</option>
                </select>
              </div>
              
              <div id="persona-info" style="display: none; padding: 1rem; background: var(--color-background-light, #f9fafb); border-radius: 6px; margin-bottom: 1.25rem;">
                <!-- Persona details will be shown here -->
              </div>
              
              <!-- Spacer to match left form fields when persona info is hidden -->
              <div id="persona-spacer" style="min-height: 158px;"></div>
              
              <div class="form-group">
                <button id="quick-login-btn" class="btn btn-cta btn-lg" style="width: 100%;" disabled>
                  Login as Selected Persona
                </button>
              </div>
            </div>
            <div class="card-footer" style="text-align: center; visibility: hidden;">
              <p style="color: var(--color-text-light); margin: 0;">
                Placeholder for alignment
              </p>
            </div>
          </div>
        </div>

        </div> <!-- End grid -->
      </div>
    </section>
  </main>

  <!-- Footer loaded dynamically from blocks/footer/ -->
  <footer></footer>

  <script type="module">
    import { authService } from '../scripts/auth.js';
    import { PERSONAS } from '../scripts/persona-config.js';
    
    // Demo account mapping: Company â†’ Persona
    const DEMO_ACCOUNTS = {
      'sunbelt_homes': {
        email: 'sarah.martinez@sunbelthomes.com',
        name: 'Sarah Martinez',
        company: 'Sunbelt Homes',
        personaId: 'sarah'
      },
      'custom_builders': {
        email: 'marcus.johnson@custombuilders.com',
        name: 'Marcus Johnson',
        company: 'Custom Builders LLC',
        personaId: 'marcus'
      },
      'elite_remodeling': {
        email: 'lisa.chen@eliteremodeling.com',
        name: 'Lisa Chen',
        company: 'Elite Remodeling',
        personaId: 'lisa'
      },
      'thompson_residence': {
        email: 'david.thompson@gmail.com',
        name: 'David Thompson',
        company: 'Thompson Residence',
        personaId: 'david'
      },
      'precision_lumber': {
        email: 'kevin.rodriguez@precisionlumber.com',
        name: 'Kevin Rodriguez',
        company: 'Precision Lumber & Supply',
        personaId: 'kevin'
      }
    };
    
    // Populate persona dropdown
    function populatePersonaDropdown() {
      const select = document.getElementById('persona-select');
      if (!select) return;
      
      // Define persona display order
      const personaOrder = ['sarah', 'marcus', 'lisa', 'david', 'kevin'];
      
      // Create options for each persona
      personaOrder.forEach(personaId => {
        const persona = Object.values(PERSONAS).find(p => p.id === personaId);
        if (!persona) return;
        
        const option = document.createElement('option');
        option.value = persona.id;
        option.textContent = `${persona.name} - ${persona.role}`;
        select.appendChild(option);
      });
    }
    
    // Show persona details when selected
    function showPersonaDetails(personaId) {
      const persona = Object.values(PERSONAS).find(p => p.id === personaId);
      const infoDiv = document.getElementById('persona-info');
      const spacer = document.getElementById('persona-spacer');
      const loginBtn = document.getElementById('quick-login-btn');
      
      if (!persona || !infoDiv || !loginBtn) return;
      
      // Show persona details and hide spacer
      infoDiv.style.display = 'block';
      if (spacer) spacer.style.display = 'none';
      
      infoDiv.innerHTML = `
        <div style="display: flex; align-items: start; gap: 1rem;">
          <div style="flex: 1;">
            <p style="margin: 0 0 0.5rem 0; font-weight: 600; color: var(--color-text);">
              ${persona.name}
            </p>
            <p style="margin: 0 0 0.25rem 0; font-size: 0.875rem; color: var(--color-text-secondary);">
              <strong>Company:</strong> ${persona.company}
            </p>
            <p style="margin: 0 0 0.25rem 0; font-size: 0.875rem; color: var(--color-text-secondary);">
              <strong>Role:</strong> ${persona.role}
            </p>
            <p style="margin: 0; font-size: 0.875rem; color: var(--color-text-light); margin-top: 0.5rem;">
              ${persona.description}
            </p>
          </div>
        </div>
      `;
      
      // Enable login button and update text
      loginBtn.disabled = false;
      loginBtn.textContent = `Login as ${persona.name.split(' ')[0]}`;
    }
    
    // Hide persona details
    function hidePersonaDetails() {
      const infoDiv = document.getElementById('persona-info');
      const spacer = document.getElementById('persona-spacer');
      const loginBtn = document.getElementById('quick-login-btn');
      
      if (infoDiv) infoDiv.style.display = 'none';
      if (spacer) spacer.style.display = 'block'; // Show spacer when details hidden
      if (loginBtn) {
        loginBtn.disabled = true;
        loginBtn.textContent = 'Login as Selected Persona';
      }
    }
    
    // Handle quick persona login
    async function handleQuickLogin() {
      const select = document.getElementById('persona-select');
      const loginBtn = document.getElementById('quick-login-btn');
      
      if (!select || !loginBtn) return;
      
      const personaId = select.value;
      if (!personaId) {
        alert('Please select a persona');
        return;
      }
      
      const originalText = loginBtn.textContent;
      loginBtn.disabled = true;
      loginBtn.textContent = 'Logging in...';
      
      try {
        console.log('[Quick Login] Logging in as persona:', personaId);
        const success = await authService.loginWithPersona(personaId);
        
        if (success) {
          console.log('[Quick Login] Successfully authenticated as:', personaId);
          
          // Check for redirect parameter
          const urlParams = new URLSearchParams(window.location.search);
          const redirect = urlParams.get('redirect');
          
          // Get default route for persona
          const defaultRoute = authService.getDefaultRoute();
          console.log('[Quick Login] Default route:', defaultRoute);
          
          // Small delay to ensure localStorage is saved
          await new Promise(resolve => setTimeout(resolve, 100));
          
          // Redirect
          if (redirect) {
            window.location.href = decodeURIComponent(redirect);
          } else {
            window.location.href = window.BASE_PATH || '/';
          }
        } else {
          throw new Error('Login failed');
        }
      } catch (error) {
        console.error('[Quick Login] Error:', error);
        alert('Login failed. Please try again.');
        loginBtn.disabled = false;
        loginBtn.textContent = originalText;
      }
    }
    
    async function handleLogin(event) {
      console.log('[Login] Form submitted');
      event.preventDefault();
      
      const email = document.getElementById('email').value.trim().toLowerCase();
      const password = document.getElementById('password').value;
      const remember = document.getElementById('remember').checked;
      
      console.log('[Login] Email:', email);
      
      // Validate inputs
      if (!email || !password) {
        alert('Please enter your email and password');
        return;
      }
      
      // Look up account by email
      const account = Object.values(DEMO_ACCOUNTS).find(
        acc => acc.email.toLowerCase() === email
      );
      
      console.log('[Login] Account found:', account ? account.name : 'none');
      
      if (!account) {
        alert('Account not found. Please check your email address.');
        return;
      }
      
      // Show loading state
      const submitBtn = event.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = 'Logging in...';
      
      try {
        // In demo mode, we accept any password
        // In production, this would validate email/password against the backend
        
        console.log('[Login] Calling loginWithPersona for:', account.personaId);
        
        // Login with persona (system knows company from email lookup)
        const success = await authService.loginWithPersona(account.personaId);
        
        console.log('[Login] loginWithPersona returned:', success);
        
        if (success) {
          console.log('[Login] Successfully authenticated as:', account.name, 'from', account.company);
          
          // Check for redirect parameter
          const urlParams = new URLSearchParams(window.location.search);
          const redirect = urlParams.get('redirect');
          
          // Get default route
          const defaultRoute = authService.getDefaultRoute();
          console.log('[Login] Default route:', defaultRoute);
          
          // Small delay to ensure localStorage is saved before redirect
          await new Promise(resolve => setTimeout(resolve, 100));
          
          // Redirect to intended page or homepage
          if (redirect) {
            console.log('[Login] Redirecting to:', decodeURIComponent(redirect));
            window.location.href = decodeURIComponent(redirect);
          } else {
            // Redirect to homepage to test fragment personalization
            console.log('[Login] Redirecting to homepage for fragment testing');
            window.location.href = window.BASE_PATH || '/';
          }
        } else {
          throw new Error('Login failed');
        }
      } catch (error) {
        console.error('[Login] Error:', error);
        alert('Login failed. Please try again.');
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    }
    
    // Attach event listener when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      // Populate persona dropdown
      populatePersonaDropdown();
      
      // Handle persona selection change
      const personaSelect = document.getElementById('persona-select');
      if (personaSelect) {
        personaSelect.addEventListener('change', (e) => {
          const personaId = e.target.value;
          if (personaId) {
            showPersonaDetails(personaId);
          } else {
            hidePersonaDetails();
          }
        });
      }
      
      // Handle quick login button click
      const quickLoginBtn = document.getElementById('quick-login-btn');
      if (quickLoginBtn) {
        quickLoginBtn.addEventListener('click', handleQuickLogin);
      }
      
      // Attach traditional login form handler
      const loginForm = document.getElementById('login-form');
      if (loginForm) {
        loginForm.addEventListener('submit', handleLogin);
      }
    });
  </script>
</body>
</html>
