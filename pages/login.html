<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - BuildRight Solutions</title>
  <script src="../scripts/scripts.js" type="module"></script>
  <link rel="stylesheet" href="../styles/styles.css">
</head>
<body>
  <!-- Header loaded dynamically from blocks/header/ -->
  <header></header>

  <!-- Main Content -->
  <main>
    <section class="section">
      <div class="container" style="max-width: 500px;">
        <div class="card">
          <div class="card-header" style="text-align: center;">
            <h1>Portal Login</h1>
            <p style="color: var(--color-text-light); margin-top: 0.5rem;">Access your personalized catalog and pricing</p>
          </div>
          <div class="card-body">
            <form id="login-form">
              <div class="form-group">
                <label for="email" class="form-label">Email Address</label>
                <input type="email" id="email" class="form-input" required placeholder="your.email@company.com">
              </div>

              <div class="form-group">
                <label for="password" class="form-label">Password</label>
                <input type="password" id="password" class="form-input" required placeholder="Enter your password">
              </div>

              <div class="form-group">
                <label for="company" class="form-label">Company</label>
                <select id="company" class="form-select" required>
                  <option value="">Select your company</option>
                  <option value="sunbelt_homes">Sunbelt Homes</option>
                  <option value="custom_builders">Custom Builders LLC</option>
                  <option value="elite_remodeling">Elite Remodeling</option>
                  <option value="thompson_residence">Thompson Residence</option>
                  <option value="buildmart_supply">BuildMart Supply</option>
                </select>
              </div>

              <div class="form-group" style="display: flex; align-items: center; gap: 0.5rem;">
                <input type="checkbox" id="remember" style="width: auto;">
                <label for="remember" style="margin: 0; font-weight: normal;">Remember me</label>
              </div>

              <div class="form-group">
                <button type="submit" class="btn btn-primary btn-lg" style="width: 100%;">Login</button>
              </div>
            </form>
          </div>
          <div class="card-footer" style="text-align: center;">
            <p style="color: var(--color-text-light); margin: 0;">
              Don't have an account? <a href="signup.html">Create an account</a>
            </p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer loaded dynamically from blocks/footer/ -->
  <footer></footer>

  <script type="module">
    import { authService } from '../scripts/auth.js';
    
    // Demo account mapping: Company → Persona
    const DEMO_ACCOUNTS = {
      'sunbelt_homes': {
        email: 'sarah.martinez@sunbelthomes.com',
        name: 'Sarah Martinez',
        company: 'Sunbelt Homes',
        personaId: 'sarah'
      },
      'custom_builders': {
        email: 'marcus.johnson@custombuilders.com',
        name: 'Marcus Johnson',
        company: 'Custom Builders LLC',
        personaId: 'marcus'
      },
      'elite_remodeling': {
        email: 'lisa.chen@eliteremodeling.com',
        name: 'Lisa Chen',
        company: 'Elite Remodeling',
        personaId: 'lisa'
      },
      'thompson_residence': {
        email: 'david.thompson@gmail.com',
        name: 'David Thompson',
        company: 'Thompson Residence',
        personaId: 'david'
      },
      'buildmart_supply': {
        email: 'kevin.rodriguez@buildmart.com',
        name: 'Kevin Rodriguez',
        company: 'BuildMart Supply',
        personaId: 'kevin'
      }
    };
    
    async function handleLogin(event) {
      event.preventDefault();
      
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const companyKey = document.getElementById('company').value;
      const remember = document.getElementById('remember').checked;
      
      // Validate inputs
      if (!email || !password || !companyKey) {
        alert('Please fill in all fields');
        return;
      }
      
      // Get demo account for selected company
      const account = DEMO_ACCOUNTS[companyKey];
      
      if (!account) {
        alert('Invalid company selection');
        return;
      }
      
      // Show loading state
      const submitBtn = event.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = 'Logging in...';
      
      try {
        // In demo mode, we accept any password
        // In production, this would validate against the backend
        
        // Login with persona (maps company → persona behind the scenes)
        const success = await authService.loginWithPersona(account.personaId);
        
        if (success) {
          console.log('[Login] Successfully authenticated as:', account.name);
          
          // Check for redirect parameter
          const urlParams = new URLSearchParams(window.location.search);
          const redirect = urlParams.get('redirect');
          
          // Redirect to intended page or dashboard
          if (redirect) {
            window.location.href = decodeURIComponent(redirect);
          } else {
            // Redirect to persona-specific dashboard
            window.location.href = authService.getDefaultRoute();
          }
        } else {
          throw new Error('Login failed');
        }
      } catch (error) {
        console.error('[Login] Error:', error);
        alert('Login failed. Please try again.');
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    }
    
    // Auto-fill email when company is selected (for demo convenience)
    document.getElementById('company').addEventListener('change', (e) => {
      const companyKey = e.target.value;
      const account = DEMO_ACCOUNTS[companyKey];
      
      if (account) {
        document.getElementById('email').value = account.email;
      }
    });
    
    // Attach event listener when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      const loginForm = document.getElementById('login-form');
      if (loginForm) {
        loginForm.addEventListener('submit', handleLogin);
      }
    });
  </script>
</body>
</html>
