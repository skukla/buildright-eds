<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Critical initialization: BASE_PATH, cart preload, variant detection -->
  <script src="../scripts/critical-init.js"></script>
  <title>Login - BuildRight Solutions</title>
  <script src="../scripts/scripts.js" type="module"></script>
  <link rel="stylesheet" href="../styles/styles.css">
  <link rel="stylesheet" href="../styles/login.css">
</head>
<body class="page-login">
  <!-- Header loaded dynamically from blocks/header/ -->
  <header></header>

  <!-- Main Content -->
  <main>
    <section class="section section-compact">
      <div class="login-container">
        
        <div class="login-header">
          <h1>Login</h1>
          <p>Access your personalized catalog and pricing</p>
        </div>

        <!-- Single Combined Login Card -->
        <div class="login-card-single">
          <div class="login-card">
            <div class="login-card-body">
              
              <!-- Login Method Tabs -->
              <div class="login-tabs">
                <button type="button" class="login-tab active" data-tab="email">
                  Email Login
                </button>
                <button type="button" class="login-tab" data-tab="persona">
                  Quick Login (Demo)
                </button>
              </div>
              
              <!-- Email Login Form -->
              <div id="email-login" class="login-tab-content active">
                <form id="login-form">
                  <div class="login-form-group">
                    <label for="email" class="login-form-label">Email Address</label>
                    <input type="email" id="email" class="login-form-input" required placeholder="your.email@company.com">
                  </div>

                  <div class="login-form-group">
                    <label for="password" class="login-form-label">Password</label>
                    <input type="password" id="password" class="login-form-input" required placeholder="Enter your password">
                  </div>

                  <div class="login-form-group">
                    <div class="login-checkbox-group">
                      <input type="checkbox" id="remember">
                      <label for="remember">Remember me</label>
                    </div>
                  </div>

                  <div class="login-form-group">
                    <button type="submit" class="btn btn-cta btn-lg" style="width: 100%;">Login</button>
                  </div>
                </form>
              </div>
              
              <!-- Persona Login Form -->
              <div id="persona-login" class="login-tab-content">
                <div class="login-form-group">
                  <label for="persona-select" class="login-form-label">Choose a Persona</label>
                  <select id="persona-select" class="login-form-input">
                    <option value="">-- Select a persona --</option>
                  </select>
                </div>
                
                <div id="persona-info" class="persona-info" style="display: none;">
                  <!-- Persona details will be shown here -->
                </div>
                
                <div class="login-form-group">
                  <button id="quick-login-btn" class="btn btn-cta btn-lg" style="width: 100%;" disabled>
                    Login as Selected Persona
                  </button>
                </div>
              </div>
              
            </div>
            <div class="login-card-footer">
              <p>
                Don't have an account? <a href="/pages/signup.html">Create an account</a>
              </p>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer loaded dynamically from blocks/footer/ -->
  <footer></footer>

  <script type="module">
    import { authService } from '../scripts/auth.js';
    import { PERSONAS } from '../scripts/persona-config.js';
    
    // Demo account mapping: Company â†’ Persona
    const DEMO_ACCOUNTS = {
      'sunbelt_homes': {
        email: 'sarah.martinez@sunbelthomes.com',
        name: 'Sarah Martinez',
        company: 'Sunbelt Homes',
        personaId: 'sarah'
      },
      'custom_builders': {
        email: 'marcus.johnson@custombuilders.com',
        name: 'Marcus Johnson',
        company: 'Custom Builders LLC',
        personaId: 'marcus'
      },
      'elite_remodeling': {
        email: 'lisa.chen@eliteremodeling.com',
        name: 'Lisa Chen',
        company: 'Elite Remodeling',
        personaId: 'lisa'
      },
      'thompson_residence': {
        email: 'david.thompson@gmail.com',
        name: 'David Thompson',
        company: 'Thompson Residence',
        personaId: 'david'
      },
      'precision_lumber': {
        email: 'kevin.rodriguez@precisionlumber.com',
        name: 'Kevin Rodriguez',
        company: 'Precision Lumber & Supply',
        personaId: 'kevin'
      }
    };
    
    // Populate persona dropdown
    function populatePersonaDropdown() {
      const select = document.getElementById('persona-select');
      if (!select) return;
      
      // Define persona display order
      const personaOrder = ['sarah', 'marcus', 'lisa', 'david', 'kevin'];
      
      // Create options for each persona
      personaOrder.forEach(personaId => {
        const persona = Object.values(PERSONAS).find(p => p.id === personaId);
        if (!persona) return;
        
        const option = document.createElement('option');
        option.value = persona.id;
        option.textContent = `${persona.name} - ${persona.role}`;
        select.appendChild(option);
      });
    }
    
    // Show persona details when selected
    function showPersonaDetails(personaId) {
      const persona = Object.values(PERSONAS).find(p => p.id === personaId);
      const infoDiv = document.getElementById('persona-info');
      const spacer = document.getElementById('persona-spacer');
      const loginBtn = document.getElementById('quick-login-btn');
      
      if (!persona || !infoDiv || !loginBtn) return;
      
      // Show persona details and hide spacer
      infoDiv.style.display = 'block';
      if (spacer) spacer.style.display = 'none';
      
      infoDiv.innerHTML = `
        <p class="persona-info-name">${persona.name}</p>
        <p class="persona-info-detail"><strong>Company:</strong> ${persona.company}</p>
        <p class="persona-info-detail"><strong>Role:</strong> ${persona.role}</p>
        <p class="persona-info-description">${persona.description}</p>
      `;
      
      // Enable login button and update text
      loginBtn.disabled = false;
      loginBtn.textContent = `Login as ${persona.name.split(' ')[0]}`;
    }
    
    // Hide persona details
    function hidePersonaDetails() {
      const infoDiv = document.getElementById('persona-info');
      const spacer = document.getElementById('persona-spacer');
      const loginBtn = document.getElementById('quick-login-btn');
      
      if (infoDiv) infoDiv.style.display = 'none';
      if (spacer) spacer.style.display = 'block'; // Show spacer when details hidden
      if (loginBtn) {
        loginBtn.disabled = true;
        loginBtn.textContent = 'Login as Selected Persona';
      }
    }
    
    // Handle quick persona login
    async function handleQuickLogin() {
      const select = document.getElementById('persona-select');
      const loginBtn = document.getElementById('quick-login-btn');
      
      if (!select || !loginBtn) return;
      
      const personaId = select.value;
      if (!personaId) {
        alert('Please select a persona');
        return;
      }
      
      const originalText = loginBtn.textContent;
      loginBtn.disabled = true;
      loginBtn.textContent = 'Logging in...';
      
      try {
        console.log('[Quick Login] Logging in as persona:', personaId);
        const success = await authService.loginWithPersona(personaId);
        
        if (success) {
          console.log('[Quick Login] Successfully authenticated as:', personaId);
          
          // Check for redirect parameter
          const urlParams = new URLSearchParams(window.location.search);
          const redirect = urlParams.get('redirect');
          
          // Get default route for persona
          const defaultRoute = authService.getDefaultRoute();
          console.log('[Quick Login] Default route:', defaultRoute);
          
          // Small delay to ensure localStorage is saved
          await new Promise(resolve => setTimeout(resolve, 100));
          
          // Redirect
          if (redirect) {
            window.location.href = decodeURIComponent(redirect);
          } else {
            window.location.href = window.BASE_PATH || '/';
          }
        } else {
          throw new Error('Login failed');
        }
      } catch (error) {
        console.error('[Quick Login] Error:', error);
        alert('Login failed. Please try again.');
        loginBtn.disabled = false;
        loginBtn.textContent = originalText;
      }
    }
    
    async function handleLogin(event) {
      console.log('[Login] Form submitted');
      event.preventDefault();
      
      const email = document.getElementById('email').value.trim().toLowerCase();
      const password = document.getElementById('password').value;
      const remember = document.getElementById('remember').checked;
      
      console.log('[Login] Email:', email);
      
      // Validate inputs
      if (!email || !password) {
        alert('Please enter your email and password');
        return;
      }
      
      // Look up account by email
      const account = Object.values(DEMO_ACCOUNTS).find(
        acc => acc.email.toLowerCase() === email
      );
      
      console.log('[Login] Account found:', account ? account.name : 'none');
      
      if (!account) {
        alert('Account not found. Please check your email address.');
        return;
      }
      
      // Show loading state
      const submitBtn = event.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = 'Logging in...';
      
      try {
        // In demo mode, we accept any password
        // In production, this would validate email/password against the backend
        
        console.log('[Login] Calling loginWithPersona for:', account.personaId);
        
        // Login with persona (system knows company from email lookup)
        const success = await authService.loginWithPersona(account.personaId);
        
        console.log('[Login] loginWithPersona returned:', success);
        
        if (success) {
          console.log('[Login] Successfully authenticated as:', account.name, 'from', account.company);
          
          // Check for redirect parameter
          const urlParams = new URLSearchParams(window.location.search);
          const redirect = urlParams.get('redirect');
          
          // Get default route
          const defaultRoute = authService.getDefaultRoute();
          console.log('[Login] Default route:', defaultRoute);
          
          // Small delay to ensure localStorage is saved before redirect
          await new Promise(resolve => setTimeout(resolve, 100));
          
          // Redirect to intended page or homepage
          if (redirect) {
            console.log('[Login] Redirecting to:', decodeURIComponent(redirect));
            window.location.href = decodeURIComponent(redirect);
          } else {
            // Redirect to homepage to test fragment personalization
            console.log('[Login] Redirecting to homepage for fragment testing');
            window.location.href = window.BASE_PATH || '/';
          }
        } else {
          throw new Error('Login failed');
        }
      } catch (error) {
        console.error('[Login] Error:', error);
        alert('Login failed. Please try again.');
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    }
    
    // Handle tab switching
    function switchTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.login-tab').forEach(tab => {
        if (tab.dataset.tab === tabName) {
          tab.classList.add('active');
        } else {
          tab.classList.remove('active');
        }
      });
      
      // Update tab content
      document.querySelectorAll('.login-tab-content').forEach(content => {
        if (content.id === `${tabName}-login`) {
          content.classList.add('active');
        } else {
          content.classList.remove('active');
        }
      });
    }
    
    // Attach event listener when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      // Populate persona dropdown
      populatePersonaDropdown();
      
      // Handle tab clicks
      document.querySelectorAll('.login-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          switchTab(tab.dataset.tab);
        });
      });
      
      // Handle persona selection change
      const personaSelect = document.getElementById('persona-select');
      if (personaSelect) {
        personaSelect.addEventListener('change', (e) => {
          const personaId = e.target.value;
          if (personaId) {
            showPersonaDetails(personaId);
          } else {
            hidePersonaDetails();
          }
        });
      }
      
      // Handle quick login button click
      const quickLoginBtn = document.getElementById('quick-login-btn');
      if (quickLoginBtn) {
        quickLoginBtn.addEventListener('click', handleQuickLogin);
      }
      
      // Attach traditional login form handler
      const loginForm = document.getElementById('login-form');
      if (loginForm) {
        loginForm.addEventListener('submit', handleLogin);
      }
    });
  </script>
</body>
</html>
