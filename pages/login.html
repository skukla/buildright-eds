<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - BuildRight Solutions</title>
  <script src="../scripts/scripts.js" type="module"></script>
  <link rel="stylesheet" href="../styles/styles.css">
</head>
<body>
  <!-- Header loaded dynamically from blocks/header/ -->
  <header></header>

  <!-- Main Content -->
  <main>
    <section class="section">
      <div class="container" style="max-width: 500px;">
        <div class="card">
          <div class="card-header" style="text-align: center;">
            <h1>Login</h1>
            <p style="color: var(--color-text-light); margin-top: 0.5rem;">Access your personalized catalog and pricing</p>
          </div>
          <div class="card-body">
            <form id="login-form">
              <div class="form-group">
                <label for="email" class="form-label">Email Address</label>
                <input type="email" id="email" class="form-input" required placeholder="your.email@company.com">
              </div>

              <div class="form-group">
                <label for="password" class="form-label">Password</label>
                <input type="password" id="password" class="form-input" required placeholder="Enter your password">
              </div>

              <div class="form-group" style="display: flex; align-items: center; gap: 0.5rem;">
                <input type="checkbox" id="remember" style="width: auto;">
                <label for="remember" style="margin: 0; font-weight: normal;">Remember me</label>
              </div>

              <div class="form-group">
                <button type="submit" class="btn btn-primary btn-lg" style="width: 100%;">Login</button>
              </div>
            </form>
          </div>
          <div class="card-footer" style="text-align: center;">
            <p style="color: var(--color-text-light); margin: 0;">
              Don't have an account? <a href="/pages/signup.html">Create an account</a>
            </p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer loaded dynamically from blocks/footer/ -->
  <footer></footer>

  <script type="module">
    import { authService } from '../scripts/auth.js';
    
    // Demo account mapping: Company â†’ Persona
    const DEMO_ACCOUNTS = {
      'sunbelt_homes': {
        email: 'sarah.martinez@sunbelthomes.com',
        name: 'Sarah Martinez',
        company: 'Sunbelt Homes',
        personaId: 'sarah'
      },
      'custom_builders': {
        email: 'marcus.johnson@custombuilders.com',
        name: 'Marcus Johnson',
        company: 'Custom Builders LLC',
        personaId: 'marcus'
      },
      'elite_remodeling': {
        email: 'lisa.chen@eliteremodeling.com',
        name: 'Lisa Chen',
        company: 'Elite Remodeling',
        personaId: 'lisa'
      },
      'thompson_residence': {
        email: 'david.thompson@gmail.com',
        name: 'David Thompson',
        company: 'Thompson Residence',
        personaId: 'david'
      },
      'precision_lumber': {
        email: 'kevin.rodriguez@precisionlumber.com',
        name: 'Kevin Rodriguez',
        company: 'Precision Lumber & Supply',
        personaId: 'kevin'
      }
    };
    
    async function handleLogin(event) {
      console.log('[Login] Form submitted');
      event.preventDefault();
      
      const email = document.getElementById('email').value.trim().toLowerCase();
      const password = document.getElementById('password').value;
      const remember = document.getElementById('remember').checked;
      
      console.log('[Login] Email:', email);
      
      // Validate inputs
      if (!email || !password) {
        alert('Please enter your email and password');
        return;
      }
      
      // Look up account by email
      const account = Object.values(DEMO_ACCOUNTS).find(
        acc => acc.email.toLowerCase() === email
      );
      
      console.log('[Login] Account found:', account ? account.name : 'none');
      
      if (!account) {
        alert('Account not found. Please check your email address.');
        return;
      }
      
      // Show loading state
      const submitBtn = event.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = 'Logging in...';
      
      try {
        // In demo mode, we accept any password
        // In production, this would validate email/password against the backend
        
        console.log('[Login] Calling loginWithPersona for:', account.personaId);
        
        // Login with persona (system knows company from email lookup)
        const success = await authService.loginWithPersona(account.personaId);
        
        console.log('[Login] loginWithPersona returned:', success);
        
        if (success) {
          console.log('[Login] Successfully authenticated as:', account.name, 'from', account.company);
          
          // Check for redirect parameter
          const urlParams = new URLSearchParams(window.location.search);
          const redirect = urlParams.get('redirect');
          
          // Get default route
          const defaultRoute = authService.getDefaultRoute();
          console.log('[Login] Default route:', defaultRoute);
          
          // Small delay to ensure localStorage is saved before redirect
          await new Promise(resolve => setTimeout(resolve, 100));
          
          // Redirect to intended page or homepage
          if (redirect) {
            console.log('[Login] Redirecting to:', decodeURIComponent(redirect));
            window.location.href = decodeURIComponent(redirect);
          } else {
            // Redirect to homepage to test fragment personalization
            console.log('[Login] Redirecting to homepage for fragment testing');
            window.location.href = '/';
          }
        } else {
          throw new Error('Login failed');
        }
      } catch (error) {
        console.error('[Login] Error:', error);
        alert('Login failed. Please try again.');
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    }
    
    // Attach event listener when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      const loginForm = document.getElementById('login-form');
      if (loginForm) {
        loginForm.addEventListener('submit', handleLogin);
      }
    });
  </script>
</body>
</html>
